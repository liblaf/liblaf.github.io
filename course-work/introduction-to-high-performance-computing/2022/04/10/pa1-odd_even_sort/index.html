<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="prefer-datetime-locale" content="en">
<meta name="generator" content="Jekyll v4.2.2">
<meta property="og:title" content="PA1: 奇偶排序（odd_even_sort）">
<meta property="og:locale" content="en">
<meta name="description" content="Performance">
<meta property="og:description" content="Performance">
<link rel="canonical" href="https://blog.liblaf.top/course-work/introduction-to-high-performance-computing/2022/04/10/pa1-odd_even_sort/">
<meta property="og:url" content="https://blog.liblaf.top/course-work/introduction-to-high-performance-computing/2022/04/10/pa1-odd_even_sort/">
<meta property="og:site_name" content="liblaf's Blog">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2022-04-10T00:00:00+08:00">
<meta name="twitter:card" content="summary">
<meta property="twitter:title" content="PA1: 奇偶排序（odd_even_sort）">
<meta name="twitter:site" content="@twitter_username"> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-04-10T00:00:00+08:00","datePublished":"2022-04-10T00:00:00+08:00","description":"Performance","headline":"PA1: 奇偶排序（odd_even_sort）","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.liblaf.top/course-work/introduction-to-high-performance-computing/2022/04/10/pa1-odd_even_sort/"},"url":"https://blog.liblaf.top/course-work/introduction-to-high-performance-computing/2022/04/10/pa1-odd_even_sort/"}</script><title>PA1: 奇偶排序（odd_even_sort） | liblaf's Blog</title>
<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">
<link rel="manifest" href="/assets/img/favicons/site.webmanifest">
<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="liblaf's Blog">
<meta name="application-name" content="liblaf's Blog">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="dns-prefetch" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="dns-prefetch" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&amp;display=swap">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css">
<link rel="stylesheet" href="/assets/css/style.css">
<link rel="stylesheet" href="/assets/css/auto_number.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script>
</head>
<body data-spy="scroll" data-target="#toc" data-topbar-visible="true">
<div id="sidebar" class="d-flex flex-column align-items-end">
<div class="profile-wrapper text-center">
<div id="avatar"> <a href="/" class="mx-auto"> <img src="https://cdn.liblaf.top/avatar-transparent.png" alt="avatar" onerror="this.style.display='none'"> </a>
</div>
<div class="site-title mt-3"> <a href="/">liblaf's Blog</a>
</div>
<div class="site-subtitle font-italic">Life blooms like a flower</div>
</div>
<ul class="w-100">
<li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a>
</li>
<li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a>
</li>
<li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a>
</li>
<li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a>
</li>
<li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a>
</li>
</ul>
<div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/liblaf" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="javascript:location.href%20=%20'mailto:'%20+%20%5B'liblaf','outlook.com'%5D.join('@')" aria-label="email"> <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss"> <i class="fas fa-rss"></i> </a> <a href="https://stackoverflow.com/users/18410348/liblaf" aria-label="stack-overflow" target="_blank" rel="noopener"> <i class="fab fa-stack-overflow"></i> </a>
</div>
</div>
<div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>PA1: 奇偶排序（odd_even_sort）</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div>
<i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel">Cancel</span>
</div></div>
<div id="main-wrapper" class="d-flex justify-content-center">
<div id="main" class="container pl-xl-4 pr-xl-4">
<div class="row">
<div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2">
<h1 data-toc-skip>PA1: 奇偶排序（odd_even_sort）</h1>
<div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1649520000" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Apr 10, 2022 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://github.com/liblaf">Qin Li</a> </em> </span><div> <span id="busuanzi_container_page_pv"> <em id="pv" class="pageviews"> <span id="busuanzi_value_page_pv"> <i class="fas fa-spinner fa-spin fa-fw"></i> </span> </em> views </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="4804 words"> <em>26 min</em> read</span> <span> <em> <a href="https://github.com/liblaf/blog/tree/main/_posts/course-work/course-work-hpc/2022-04-10-pa1-odd_even_sort.md"> <i class="fas fa-eye"></i> View on GitHub </a> </em> </span>
</div>
</div>
</div>
<div class="post-content">
<h2 id="performance">
<span class="mr-2">Performance</span><a href="#performance" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>
<div class="table-wrapper"><table>
<thead><tr>
<th>Number of Nodes</th>
<th>Number of Tasks</th>
<th>Number Count</th>
<th>v0</th>
<th>v1</th>
<th>v2</th>
<th>v3</th>
<th>v4</th>
</tr></thead>
<tbody>
<tr>
<td>1</td>
<td>1</td>
<td>100000000</td>
<td>1.</td>
<td>1.</td>
<td>1.</td>
<td>1.</td>
<td>1.</td>
</tr>
<tr>
<td>1</td>
<td>2</td>
<td>100000000</td>
<td>1.82738226</td>
<td>1.83557525</td>
<td>1.8772568</td>
<td>1.86270894</td>
<td>1.67925379</td>
</tr>
<tr>
<td>1</td>
<td>4</td>
<td>100000000</td>
<td>3.05696721</td>
<td>3.17540441</td>
<td>3.37059297</td>
<td>3.39672385</td>
<td>2.3387731</td>
</tr>
<tr>
<td>1</td>
<td>8</td>
<td>100000000</td>
<td>5.15212684</td>
<td>5.59405831</td>
<td>6.03427353</td>
<td>6.15270254</td>
<td>3.29768106</td>
</tr>
<tr>
<td>1</td>
<td>16</td>
<td>100000000</td>
<td>7.65590815</td>
<td>8.91877194</td>
<td>9.65970998</td>
<td>10.31895407</td>
<td>4.39598177</td>
</tr>
<tr>
<td>2</td>
<td>32</td>
<td>100000000</td>
<td>10.63745468</td>
<td>12.91174115</td>
<td>14.70125847</td>
<td>15.67950831</td>
<td>5.01147717</td>
</tr>
</tbody>
</table></div>
<h2 id="v0">
<span class="mr-2">v0</span><a href="#v0" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>
<p><code class="language-plaintext highlighter-rouge">AllReduceBitwiseAnd</code> + Blocking Communication + Naive Merge</p>
<p>每轮归并后 <code class="language-plaintext highlighter-rouge">AllReduce</code> 检查是否已为有序.</p>
<h3 id="allreducebitwiseand">
<span class="mr-2"><code class="language-plaintext highlighter-rouge"><span class="mr-2">AllReduceBitwiseAnd</span></code></span><a href="#allreducebitwiseand" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>
<div class="language-plaintext highlighter-rouge">
<div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td>
<td class="rouge-code"><pre>0 -&gt; 1 -&gt; ... -&gt; (nprocs - 1) -&gt; 0 # Tag 1
0 -&gt; 1 -&gt; ... -&gt; (nprocs - 2) # Tag 2
</pre></td>
</tr></tbody></table></code></div>
</div>
<h3 id="source-code">
<span class="mr-2">Source Code</span><a href="#source-code" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>
<div class="language-c++ highlighter-rouge">
<div class="code-header"> <span data-label-text="C++"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
</pre></td>
<td class="rouge-code"><pre><span class="c1">// odd_even_sort.cpp</span>
<span class="cp">#include</span> <span class="cpf">&lt;mpi.h&gt;</span><span class="cp">
</span>
<span class="cp">#include</span> <span class="cpf">&lt;algorithm&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;cassert&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;cmath&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;cstdio&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;cstdlib&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;cstring&gt;</span><span class="cp">
</span>
<span class="cp">#include</span> <span class="cpf">"worker.h"</span><span class="cp">
</span>
<span class="kt">size_t</span> <span class="nf">CalcBlockLen</span><span class="p">(</span><span class="k">const</span> <span class="kt">size_t</span> <span class="n">n</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">nprocs</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">rank</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">size_t</span> <span class="n">block_size</span> <span class="o">=</span> <span class="n">ceiling</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">nprocs</span><span class="p">);</span>
  <span class="kt">size_t</span> <span class="n">IO_offset</span> <span class="o">=</span> <span class="n">block_size</span> <span class="o">*</span> <span class="n">rank</span><span class="p">;</span>
  <span class="kt">bool</span> <span class="n">out_of_range</span> <span class="o">=</span> <span class="n">IO_offset</span> <span class="o">&gt;=</span> <span class="n">n</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">out_of_range</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">block_size</span><span class="p">,</span> <span class="n">n</span> <span class="o">-</span> <span class="n">IO_offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">AllReduceBitwiseAnd</span><span class="p">(</span><span class="kt">int</span> <span class="n">sendbuf</span><span class="p">,</span> <span class="n">MPI_Comm</span> <span class="n">comm</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">nprocs</span><span class="p">,</span>
                        <span class="k">const</span> <span class="kt">int</span> <span class="n">current_rank</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">nprocs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="n">sendbuf</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">succ_rank</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_rank</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">nprocs</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">pred_rank</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_rank</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">nprocs</span><span class="p">)</span> <span class="o">%</span> <span class="n">nprocs</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">current_rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">MPI_Send</span><span class="p">(</span><span class="cm">/*buf=*/</span><span class="o">&amp;</span><span class="n">sendbuf</span><span class="p">,</span> <span class="cm">/*count=*/</span><span class="mi">1</span><span class="p">,</span> <span class="cm">/*datatype=*/</span><span class="n">MPI_INT</span><span class="p">,</span>
             <span class="cm">/*dest=*/</span><span class="n">succ_rank</span><span class="p">,</span> <span class="cm">/*tag=*/</span><span class="mi">1</span><span class="p">,</span> <span class="cm">/*comm=*/</span><span class="n">comm</span><span class="p">);</span>
    <span class="n">MPI_Recv</span><span class="p">(</span><span class="cm">/*buf=*/</span><span class="o">&amp;</span><span class="n">sendbuf</span><span class="p">,</span> <span class="cm">/*count=*/</span><span class="mi">1</span><span class="p">,</span> <span class="cm">/*datatype=*/</span><span class="n">MPI_INT</span><span class="p">,</span>
             <span class="cm">/*source=*/</span><span class="n">pred_rank</span><span class="p">,</span> <span class="cm">/*tag=*/</span><span class="mi">1</span><span class="p">,</span> <span class="cm">/*comm=*/</span><span class="n">comm</span><span class="p">,</span>
             <span class="cm">/*status=*/</span><span class="nb">nullptr</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">succ_rank</span> <span class="o">!=</span> <span class="n">nprocs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
      <span class="n">MPI_Send</span><span class="p">(</span><span class="cm">/*buf=*/</span><span class="o">&amp;</span><span class="n">sendbuf</span><span class="p">,</span> <span class="cm">/*count=*/</span><span class="mi">1</span><span class="p">,</span> <span class="cm">/*datatype=*/</span><span class="n">MPI_INT</span><span class="p">,</span>
               <span class="cm">/*dest=*/</span><span class="n">succ_rank</span><span class="p">,</span> <span class="cm">/*tag=*/</span><span class="mi">2</span><span class="p">,</span> <span class="cm">/*comm=*/</span><span class="n">comm</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="kt">bool</span> <span class="n">recvbuf</span><span class="p">;</span>
    <span class="n">MPI_Recv</span><span class="p">(</span><span class="cm">/*buf=*/</span><span class="o">&amp;</span><span class="n">recvbuf</span><span class="p">,</span> <span class="cm">/*count=*/</span><span class="mi">1</span><span class="p">,</span> <span class="cm">/*datatype=*/</span><span class="n">MPI_INT</span><span class="p">,</span>
             <span class="cm">/*source=*/</span><span class="n">pred_rank</span><span class="p">,</span> <span class="cm">/*tag=*/</span><span class="mi">1</span><span class="p">,</span> <span class="cm">/*comm=*/</span><span class="n">comm</span><span class="p">,</span>
             <span class="cm">/*status=*/</span><span class="nb">nullptr</span><span class="p">);</span>
    <span class="n">sendbuf</span> <span class="o">&amp;=</span> <span class="n">recvbuf</span><span class="p">;</span>
    <span class="n">MPI_Send</span><span class="p">(</span><span class="cm">/*buf=*/</span><span class="o">&amp;</span><span class="n">sendbuf</span><span class="p">,</span> <span class="cm">/*count=*/</span><span class="mi">1</span><span class="p">,</span> <span class="cm">/*datatype=*/</span><span class="n">MPI_INT</span><span class="p">,</span>
             <span class="cm">/*dest=*/</span><span class="n">succ_rank</span><span class="p">,</span> <span class="cm">/*tag=*/</span><span class="mi">1</span><span class="p">,</span> <span class="cm">/*comm=*/</span><span class="n">comm</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">current_rank</span> <span class="o">!=</span> <span class="n">nprocs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">MPI_Recv</span><span class="p">(</span><span class="cm">/*buf=*/</span><span class="o">&amp;</span><span class="n">sendbuf</span><span class="p">,</span> <span class="cm">/*count=*/</span><span class="mi">1</span><span class="p">,</span> <span class="cm">/*datatype=*/</span><span class="n">MPI_INT</span><span class="p">,</span>
               <span class="cm">/*source=*/</span><span class="n">pred_rank</span><span class="p">,</span> <span class="cm">/*tag=*/</span><span class="mi">2</span><span class="p">,</span> <span class="cm">/*comm=*/</span><span class="n">comm</span><span class="p">,</span>
               <span class="cm">/*status=*/</span><span class="nb">nullptr</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">succ_rank</span> <span class="o">!=</span> <span class="n">nprocs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">MPI_Send</span><span class="p">(</span><span class="cm">/*buf=*/</span><span class="o">&amp;</span><span class="n">sendbuf</span><span class="p">,</span> <span class="cm">/*count=*/</span><span class="mi">1</span><span class="p">,</span> <span class="cm">/*datatype=*/</span><span class="n">MPI_INT</span><span class="p">,</span>
                 <span class="cm">/*dest=*/</span><span class="n">succ_rank</span><span class="p">,</span> <span class="cm">/*tag=*/</span><span class="mi">2</span><span class="p">,</span> <span class="cm">/*comm=*/</span><span class="n">comm</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">sendbuf</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Worker</span><span class="o">::</span><span class="n">sort</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">out_of_range</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">sort</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">nprocs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">left_rank</span> <span class="o">=</span> <span class="p">((</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">rank</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
  <span class="kt">size_t</span> <span class="n">left_block_len</span> <span class="o">=</span> <span class="n">CalcBlockLen</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">,</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">nprocs</span><span class="p">,</span> <span class="n">left_rank</span><span class="p">);</span>
  <span class="kt">int</span> <span class="n">right_rank</span> <span class="o">=</span> <span class="p">((</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">rank</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">nprocs</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">rank</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
  <span class="kt">size_t</span> <span class="n">right_block_len</span> <span class="o">=</span> <span class="n">CalcBlockLen</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">,</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">nprocs</span><span class="p">,</span> <span class="n">right_rank</span><span class="p">);</span>
  <span class="kt">float</span><span class="o">*</span> <span class="n">neighbor_data</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">float</span><span class="p">[</span><span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="n">left_block_len</span><span class="p">,</span> <span class="n">right_block_len</span><span class="p">)];</span>
  <span class="kt">float</span><span class="o">*</span> <span class="n">merged_data</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">float</span><span class="p">[</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span><span class="p">];</span>
  <span class="kt">bool</span> <span class="n">sorted</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">// even stage</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">AllReduceBitwiseAnd</span><span class="p">(</span><span class="n">sorted</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">nprocs</span><span class="p">,</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">rank</span><span class="p">))</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="n">sorted</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kt">int</span> <span class="n">neighbor_rank</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">neighbor_block_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">^</span> <span class="p">((</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">rank</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">neighbor_rank</span> <span class="o">=</span> <span class="n">right_rank</span><span class="p">;</span>
      <span class="n">neighbor_block_len</span> <span class="o">=</span> <span class="n">right_block_len</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">neighbor_rank</span> <span class="o">=</span> <span class="n">left_rank</span><span class="p">;</span>
      <span class="n">neighbor_block_len</span> <span class="o">=</span> <span class="n">left_block_len</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">neighbor_block_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// no neighbor</span>
      <span class="n">sorted</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
      <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">MPI_Status</span> <span class="n">status</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">neighbor_rank</span> <span class="o">==</span> <span class="n">left_rank</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">MPI_Sendrecv</span><span class="p">(</span><span class="cm">/*sendbuf=*/</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="cm">/*sendcount=*/</span><span class="mi">1</span><span class="p">,</span>
                   <span class="cm">/*sendtype=*/</span><span class="n">MPI_FLOAT</span><span class="p">,</span> <span class="cm">/*dest=*/</span><span class="n">neighbor_rank</span><span class="p">,</span>
                   <span class="cm">/*sendtag=*/</span><span class="n">i</span><span class="p">,</span> <span class="cm">/*recvbuf=*/</span><span class="n">neighbor_data</span><span class="p">,</span> <span class="cm">/*recvcount=*/</span><span class="mi">1</span><span class="p">,</span>
                   <span class="cm">/*recvtype=*/</span><span class="n">MPI_FLOAT</span><span class="p">,</span> <span class="cm">/*source=*/</span><span class="n">neighbor_rank</span><span class="p">,</span>
                   <span class="cm">/*recvtag=*/</span><span class="n">i</span><span class="p">,</span> <span class="cm">/*comm=*/</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="cm">/*status=*/</span><span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">neighbor_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
        <span class="c1">// no need to merge</span>
        <span class="n">sorted</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>  <span class="c1">// neighbor_rank == right_rank</span>
      <span class="n">MPI_Sendrecv</span><span class="p">(</span><span class="cm">/*sendbuf=*/</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                   <span class="cm">/*sendcount=*/</span><span class="mi">1</span><span class="p">,</span>
                   <span class="cm">/*sendtype=*/</span><span class="n">MPI_FLOAT</span><span class="p">,</span> <span class="cm">/*dest=*/</span><span class="n">neighbor_rank</span><span class="p">,</span>
                   <span class="cm">/*sendtag=*/</span><span class="n">i</span><span class="p">,</span> <span class="cm">/*recvbuf=*/</span><span class="n">neighbor_data</span><span class="p">,</span> <span class="cm">/*recvcount=*/</span><span class="mi">1</span><span class="p">,</span>
                   <span class="cm">/*recvtype=*/</span><span class="n">MPI_FLOAT</span><span class="p">,</span> <span class="cm">/*source=*/</span><span class="n">neighbor_rank</span><span class="p">,</span>
                   <span class="cm">/*recvtag=*/</span><span class="n">i</span><span class="p">,</span> <span class="cm">/*comm=*/</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="cm">/*status=*/</span><span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">neighbor_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
        <span class="c1">// no need to merge</span>
        <span class="n">sorted</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">MPI_Sendrecv</span><span class="p">(</span><span class="cm">/*sendbuf=*/</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="cm">/*sendcount=*/</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span><span class="p">,</span>
                 <span class="cm">/*sendtype=*/</span><span class="n">MPI_FLOAT</span><span class="p">,</span> <span class="cm">/*dest=*/</span><span class="n">neighbor_rank</span><span class="p">,</span> <span class="cm">/*sendtag=*/</span><span class="n">i</span><span class="p">,</span>
                 <span class="cm">/*recvbuf=*/</span><span class="n">neighbor_data</span><span class="p">,</span> <span class="cm">/*recvcount=*/</span><span class="n">neighbor_block_len</span><span class="p">,</span>
                 <span class="cm">/*recvtype=*/</span><span class="n">MPI_FLOAT</span><span class="p">,</span> <span class="cm">/*source=*/</span><span class="n">neighbor_rank</span><span class="p">,</span>
                 <span class="cm">/*recvtag=*/</span><span class="n">i</span><span class="p">,</span> <span class="cm">/*comm=*/</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="cm">/*status=*/</span><span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
    <span class="kt">size_t</span> <span class="n">skip_count</span> <span class="o">=</span> <span class="p">(</span><span class="n">neighbor_rank</span> <span class="o">==</span> <span class="n">left_rank</span><span class="p">)</span> <span class="o">?</span> <span class="n">neighbor_block_len</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">neighbor_block_len</span> <span class="o">&amp;&amp;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span> <span class="o">&amp;&amp;</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="n">skip_count</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">neighbor_data</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="p">{</span>
        <span class="o">++</span><span class="n">j</span><span class="p">;</span>
        <span class="o">++</span><span class="n">l</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="o">++</span><span class="n">k</span><span class="p">;</span>
        <span class="o">++</span><span class="n">l</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">neighbor_block_len</span> <span class="o">&amp;&amp;</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="n">skip_count</span><span class="p">)</span> <span class="p">{</span>
      <span class="o">++</span><span class="n">j</span><span class="p">;</span>
      <span class="o">++</span><span class="n">l</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">k</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span> <span class="o">&amp;&amp;</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="n">skip_count</span><span class="p">)</span> <span class="p">{</span>
      <span class="o">++</span><span class="n">k</span><span class="p">;</span>
      <span class="o">++</span><span class="n">l</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">neighbor_block_len</span> <span class="o">&amp;&amp;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span> <span class="o">&amp;&amp;</span>
           <span class="n">l</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">neighbor_data</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="p">{</span>
        <span class="n">merged_data</span><span class="p">[</span><span class="n">l</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">neighbor_data</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">];</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">merged_data</span><span class="p">[</span><span class="n">l</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="o">++</span><span class="p">];</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">neighbor_block_len</span> <span class="o">&amp;&amp;</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span><span class="p">)</span>
      <span class="n">merged_data</span><span class="p">[</span><span class="n">l</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">neighbor_data</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">];</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">k</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span> <span class="o">&amp;&amp;</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span><span class="p">)</span>
      <span class="n">merged_data</span><span class="p">[</span><span class="n">l</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="o">++</span><span class="p">];</span>
    <span class="n">std</span><span class="o">::</span><span class="n">memcpy</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">merged_data</span><span class="p">,</span> <span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
  <span class="p">}</span>
  <span class="k">delete</span><span class="p">[]</span> <span class="n">neighbor_data</span><span class="p">;</span>
  <span class="k">delete</span><span class="p">[]</span> <span class="n">merged_data</span><span class="p">;</span>
<span class="p">}</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<h3 id="performance-1">
<span class="mr-2">Performance</span><a href="#performance-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>
<div class="table-wrapper"><table>
<thead><tr>
<th>Number of Nodes</th>
<th>Number of Tasks</th>
<th>Number Count</th>
<th>Execution Time</th>
<th>Speedup</th>
</tr></thead>
<tbody>
<tr>
<td>1</td>
<td>1</td>
<td>100000000</td>
<td>12526.773000 ms</td>
<td>1.</td>
</tr>
<tr>
<td>1</td>
<td>2</td>
<td>100000000</td>
<td>6855.037000 ms</td>
<td>1.82738226</td>
</tr>
<tr>
<td>1</td>
<td>4</td>
<td>100000000</td>
<td>4097.778000 ms</td>
<td>3.05696721</td>
</tr>
<tr>
<td>1</td>
<td>8</td>
<td>100000000</td>
<td>2431.379000 ms</td>
<td>5.15212684</td>
</tr>
<tr>
<td>1</td>
<td>16</td>
<td>100000000</td>
<td>1636.223000 ms</td>
<td>7.65590815</td>
</tr>
<tr>
<td>2</td>
<td>32</td>
<td>100000000</td>
<td>1177.610000 ms</td>
<td>10.63745468</td>
</tr>
</tbody>
</table></div>
<h2 id="v1">
<span class="mr-2">v1</span><a href="#v1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>
<p>Loop <code class="language-plaintext highlighter-rouge">nprocs</code> times + Blocking Communication + Naive Merge</p>
<p>节约 <code class="language-plaintext highlighter-rouge">AllReduce</code> 的时间, 进行 <code class="language-plaintext highlighter-rouge">nprocs</code> 轮排序.</p>
<h3 id="proof-of-correctness">
<span class="mr-2">Proof of Correctness</span><a href="#proof-of-correctness" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>
<blockquote><p>Reference: <a href="https://en.wikipedia.org/wiki/Odd%E2%80%93even_sort#Proof_of_correctness">Odd–even sort - Wikipedia</a></p></blockquote>
<h4 id="claim">
<span class="mr-2">Claim</span><a href="#claim" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h4>
<p>Let $a_1, \cdots, a_n$ be a sequence of data ordered by <code class="language-plaintext highlighter-rouge">&lt;</code>. The odd-even sort algorithm correctly sorts this data in $n$ passes. (A pass here is defined to be a full sequence of odd-even, or even-odd comparisons. The passes occur in order pass 1: odd–even, pass 2: even–odd, etc.)</p>
<h4 id="proof">
<span class="mr-2">Proof</span><a href="#proof" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h4>
<p>This proof is based loosely on one by Thomas Worsch.<sup id="fnref:6" role="doc-noteref"><a href="#fn:6" class="footnote" rel="footnote">1</a></sup></p>
<p>Since the sorting algorithm only involves comparison-swap operations and is oblivious (the order of comparison-swap operations does not depend on the data), by Knuth's 0-1 sorting principle,<sup id="fnref:7" role="doc-noteref"><a href="#fn:7" class="footnote" rel="footnote">2</a></sup><sup id="fnref:8" role="doc-noteref"><a href="#fn:8" class="footnote" rel="footnote">3</a></sup> it suffices to check correctness when each $a_i$ is either 0 or 1. Assume that there are $e$ 1s.</p>
<p>Observe that the rightmost 1 can be either in an even or odd position, so it might not be moved by the first odd-even pass. But after the first odd-even pass, the rightmost 1 will be in an even position. It follows that it will be moved to the right by all remaining passes. Since the rightmost one starts in position greater than or equal to $e$, it must be moved at most $n - e$ steps. It follows that it takes at most $n - e + 1$ passes to move the rightmost 1 to its correct position.</p>
<p>Now, consider the second rightmost 1. After two passes, the 1 to its right will have moved right by at least one step. It follows that, for all remaining passes, we can view the second rightmost 1 as the rightmost 1. The second rightmost 1 starts in position at least $e - 1$ and must be moved to position at most $n - 1$, so it must be moved at most $(n - 1) - (e - 1) = n - e$ steps. After at most 2 passes, the rightmost 1 will have already moved, so the entry to the right of the second rightmost 1 will be 0. Hence, for all passes after the first two, the second rightmost 1 will move to the right. It thus takes at most $n - e + 2$ passes to move the second rightmost 1 to its correct position.</p>
<p>Continuing in this manner, by induction it can be shown that the $i$-th rightmost 1 is moved to its correct position in at most $n - e + i$ passes. Since $i \leqslant e$, it follows that the $i$-th rightmost 1 is moved to its correct position in at most $n - e + e = n$ passes. The list is thus correctly sorted in $n$ passes. QED.</p>
<p>We remark that each pass takes $O(n)$ steps, so this algorithm has $O(n^2)$ complexity.</p>
<h3 id="source-code-1">
<span class="mr-2">Source Code</span><a href="#source-code-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>
<div class="language-c++ highlighter-rouge">
<div class="code-header"> <span data-label-text="C++"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
</pre></td>
<td class="rouge-code"><pre><span class="c1">// odd_even_sort.cpp</span>
<span class="cp">#include</span> <span class="cpf">&lt;mpi.h&gt;</span><span class="cp">
</span>
<span class="cp">#include</span> <span class="cpf">&lt;algorithm&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;cassert&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;cmath&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;cstdio&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;cstdlib&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;cstring&gt;</span><span class="cp">
</span>
<span class="cp">#include</span> <span class="cpf">"worker.h"</span><span class="cp">
</span>
<span class="kt">size_t</span> <span class="nf">CalcBlockLen</span><span class="p">(</span><span class="k">const</span> <span class="kt">size_t</span> <span class="n">n</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">nprocs</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">rank</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">size_t</span> <span class="n">block_size</span> <span class="o">=</span> <span class="n">ceiling</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">nprocs</span><span class="p">);</span>
  <span class="kt">size_t</span> <span class="n">IO_offset</span> <span class="o">=</span> <span class="n">block_size</span> <span class="o">*</span> <span class="n">rank</span><span class="p">;</span>
  <span class="kt">bool</span> <span class="n">out_of_range</span> <span class="o">=</span> <span class="n">IO_offset</span> <span class="o">&gt;=</span> <span class="n">n</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">out_of_range</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">block_size</span><span class="p">,</span> <span class="n">n</span> <span class="o">-</span> <span class="n">IO_offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Worker</span><span class="o">::</span><span class="n">sort</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">out_of_range</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">sort</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">nprocs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">left_rank</span> <span class="o">=</span> <span class="p">((</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">rank</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
  <span class="kt">size_t</span> <span class="n">left_block_len</span> <span class="o">=</span> <span class="n">CalcBlockLen</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">,</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">nprocs</span><span class="p">,</span> <span class="n">left_rank</span><span class="p">);</span>
  <span class="kt">int</span> <span class="n">right_rank</span> <span class="o">=</span> <span class="p">((</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">rank</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">nprocs</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">rank</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
  <span class="kt">size_t</span> <span class="n">right_block_len</span> <span class="o">=</span> <span class="n">CalcBlockLen</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">,</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">nprocs</span><span class="p">,</span> <span class="n">right_rank</span><span class="p">);</span>
  <span class="kt">float</span><span class="o">*</span> <span class="n">neighbor_data</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">float</span><span class="p">[</span><span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="n">left_block_len</span><span class="p">,</span> <span class="n">right_block_len</span><span class="p">)];</span>
  <span class="kt">float</span><span class="o">*</span> <span class="n">merged_data</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">float</span><span class="p">[</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span><span class="p">];</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nprocs</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">neighbor_rank</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">neighbor_block_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">^</span> <span class="p">((</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">rank</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">neighbor_rank</span> <span class="o">=</span> <span class="n">right_rank</span><span class="p">;</span>
      <span class="n">neighbor_block_len</span> <span class="o">=</span> <span class="n">right_block_len</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">neighbor_rank</span> <span class="o">=</span> <span class="n">left_rank</span><span class="p">;</span>
      <span class="n">neighbor_block_len</span> <span class="o">=</span> <span class="n">left_block_len</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">neighbor_block_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
      <span class="c1">// no neighbor</span>
      <span class="k">continue</span><span class="p">;</span>
    <span class="n">MPI_Status</span> <span class="n">status</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">neighbor_rank</span> <span class="o">==</span> <span class="n">left_rank</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">MPI_Sendrecv</span><span class="p">(</span><span class="cm">/*sendbuf=*/</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="cm">/*sendcount=*/</span><span class="mi">1</span><span class="p">,</span>
                   <span class="cm">/*sendtype=*/</span><span class="n">MPI_FLOAT</span><span class="p">,</span> <span class="cm">/*dest=*/</span><span class="n">neighbor_rank</span><span class="p">,</span>
                   <span class="cm">/*sendtag=*/</span><span class="n">i</span><span class="p">,</span> <span class="cm">/*recvbuf=*/</span><span class="n">neighbor_data</span><span class="p">,</span> <span class="cm">/*recvcount=*/</span><span class="mi">1</span><span class="p">,</span>
                   <span class="cm">/*recvtype=*/</span><span class="n">MPI_FLOAT</span><span class="p">,</span> <span class="cm">/*source=*/</span><span class="n">neighbor_rank</span><span class="p">,</span>
                   <span class="cm">/*recvtag=*/</span><span class="n">i</span><span class="p">,</span> <span class="cm">/*comm=*/</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="cm">/*status=*/</span><span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">neighbor_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1">// no need to merge</span>
        <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>  <span class="c1">// neighbor_rank == right_rank</span>
      <span class="n">MPI_Sendrecv</span><span class="p">(</span><span class="cm">/*sendbuf=*/</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                   <span class="cm">/*sendcount=*/</span><span class="mi">1</span><span class="p">,</span>
                   <span class="cm">/*sendtype=*/</span><span class="n">MPI_FLOAT</span><span class="p">,</span> <span class="cm">/*dest=*/</span><span class="n">neighbor_rank</span><span class="p">,</span>
                   <span class="cm">/*sendtag=*/</span><span class="n">i</span><span class="p">,</span> <span class="cm">/*recvbuf=*/</span><span class="n">neighbor_data</span><span class="p">,</span> <span class="cm">/*recvcount=*/</span><span class="mi">1</span><span class="p">,</span>
                   <span class="cm">/*recvtype=*/</span><span class="n">MPI_FLOAT</span><span class="p">,</span> <span class="cm">/*source=*/</span><span class="n">neighbor_rank</span><span class="p">,</span>
                   <span class="cm">/*recvtag=*/</span><span class="n">i</span><span class="p">,</span> <span class="cm">/*comm=*/</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="cm">/*status=*/</span><span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">neighbor_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1">// no need to merge</span>
        <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">MPI_Sendrecv</span><span class="p">(</span><span class="cm">/*sendbuf=*/</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="cm">/*sendcount=*/</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span><span class="p">,</span>
                 <span class="cm">/*sendtype=*/</span><span class="n">MPI_FLOAT</span><span class="p">,</span> <span class="cm">/*dest=*/</span><span class="n">neighbor_rank</span><span class="p">,</span> <span class="cm">/*sendtag=*/</span><span class="n">i</span><span class="p">,</span>
                 <span class="cm">/*recvbuf=*/</span><span class="n">neighbor_data</span><span class="p">,</span> <span class="cm">/*recvcount=*/</span><span class="n">neighbor_block_len</span><span class="p">,</span>
                 <span class="cm">/*recvtype=*/</span><span class="n">MPI_FLOAT</span><span class="p">,</span> <span class="cm">/*source=*/</span><span class="n">neighbor_rank</span><span class="p">,</span>
                 <span class="cm">/*recvtag=*/</span><span class="n">i</span><span class="p">,</span> <span class="cm">/*comm=*/</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="cm">/*status=*/</span><span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
    <span class="kt">size_t</span> <span class="n">skip_count</span> <span class="o">=</span> <span class="p">(</span><span class="n">neighbor_rank</span> <span class="o">==</span> <span class="n">left_rank</span><span class="p">)</span> <span class="o">?</span> <span class="n">neighbor_block_len</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">neighbor_block_len</span> <span class="o">&amp;&amp;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span> <span class="o">&amp;&amp;</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="n">skip_count</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">neighbor_data</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="p">{</span>
        <span class="o">++</span><span class="n">j</span><span class="p">;</span>
        <span class="o">++</span><span class="n">l</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="o">++</span><span class="n">k</span><span class="p">;</span>
        <span class="o">++</span><span class="n">l</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">neighbor_block_len</span> <span class="o">&amp;&amp;</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="n">skip_count</span><span class="p">)</span> <span class="p">{</span>
      <span class="o">++</span><span class="n">j</span><span class="p">;</span>
      <span class="o">++</span><span class="n">l</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">k</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span> <span class="o">&amp;&amp;</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="n">skip_count</span><span class="p">)</span> <span class="p">{</span>
      <span class="o">++</span><span class="n">k</span><span class="p">;</span>
      <span class="o">++</span><span class="n">l</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">neighbor_block_len</span> <span class="o">&amp;&amp;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span> <span class="o">&amp;&amp;</span>
           <span class="n">l</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">neighbor_data</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="p">{</span>
        <span class="n">merged_data</span><span class="p">[</span><span class="n">l</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">neighbor_data</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">];</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">merged_data</span><span class="p">[</span><span class="n">l</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="o">++</span><span class="p">];</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">neighbor_block_len</span> <span class="o">&amp;&amp;</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span><span class="p">)</span>
      <span class="n">merged_data</span><span class="p">[</span><span class="n">l</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">neighbor_data</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">];</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">k</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span> <span class="o">&amp;&amp;</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span><span class="p">)</span>
      <span class="n">merged_data</span><span class="p">[</span><span class="n">l</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="o">++</span><span class="p">];</span>
    <span class="n">std</span><span class="o">::</span><span class="n">memcpy</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">merged_data</span><span class="p">,</span> <span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
  <span class="p">}</span>
  <span class="k">delete</span><span class="p">[]</span> <span class="n">neighbor_data</span><span class="p">;</span>
  <span class="k">delete</span><span class="p">[]</span> <span class="n">merged_data</span><span class="p">;</span>
<span class="p">}</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<h3 id="performance-2">
<span class="mr-2">Performance</span><a href="#performance-2" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>
<div class="table-wrapper"><table>
<thead><tr>
<th>Number of Nodes</th>
<th>Number of Tasks</th>
<th>Number Count</th>
<th>Execution Time</th>
<th>Speedup</th>
</tr></thead>
<tbody>
<tr>
<td>1</td>
<td>1</td>
<td>100000000</td>
<td>12511.503000 ms</td>
<td>1.</td>
</tr>
<tr>
<td>1</td>
<td>2</td>
<td>100000000</td>
<td>6816.121000 ms</td>
<td>1.83557525</td>
</tr>
<tr>
<td>1</td>
<td>4</td>
<td>100000000</td>
<td>3940.129000 ms</td>
<td>3.17540441</td>
</tr>
<tr>
<td>1</td>
<td>8</td>
<td>100000000</td>
<td>2236.570000 ms</td>
<td>5.59405831</td>
</tr>
<tr>
<td>1</td>
<td>16</td>
<td>100000000</td>
<td>1402.828000 ms</td>
<td>8.91877194</td>
</tr>
<tr>
<td>2</td>
<td>16</td>
<td>100000000</td>
<td>969.002000 ms</td>
<td>12.91174115</td>
</tr>
</tbody>
</table></div>
<h2 id="v2">
<span class="mr-2">v2</span><a href="#v2" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>
<p>Loop <code class="language-plaintext highlighter-rouge">nprocs</code> times + Blocking Communication + Optimized Merge</p>
<h3 id="optimized-merge">
<span class="mr-2">Optimized Merge</span><a href="#optimized-merge" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>
<p>左侧 Worker 从左向右 Merge, 右侧 Worker 从右向左 Merge.</p>
<h3 id="source-code-2">
<span class="mr-2">Source Code</span><a href="#source-code-2" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>
<div class="language-c++ highlighter-rouge">
<div class="code-header"> <span data-label-text="C++"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
</pre></td>
<td class="rouge-code"><pre><span class="c1">// odd_even_sort.cpp</span>
<span class="cp">#include</span> <span class="cpf">&lt;mpi.h&gt;</span><span class="cp">
</span>
<span class="cp">#include</span> <span class="cpf">&lt;algorithm&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;cassert&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;cmath&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;cstdio&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;cstdlib&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;cstring&gt;</span><span class="cp">
</span>
<span class="cp">#include</span> <span class="cpf">"worker.h"</span><span class="cp">
</span>
<span class="kt">size_t</span> <span class="nf">CalcBlockLen</span><span class="p">(</span><span class="k">const</span> <span class="kt">size_t</span> <span class="n">n</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">nprocs</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">rank</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">size_t</span> <span class="n">block_size</span> <span class="o">=</span> <span class="n">ceiling</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">nprocs</span><span class="p">);</span>
  <span class="kt">size_t</span> <span class="n">IO_offset</span> <span class="o">=</span> <span class="n">block_size</span> <span class="o">*</span> <span class="n">rank</span><span class="p">;</span>
  <span class="kt">bool</span> <span class="n">out_of_range</span> <span class="o">=</span> <span class="n">IO_offset</span> <span class="o">&gt;=</span> <span class="n">n</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">out_of_range</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">block_size</span><span class="p">,</span> <span class="n">n</span> <span class="o">-</span> <span class="n">IO_offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Worker</span><span class="o">::</span><span class="n">sort</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">sort</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">nprocs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">left_rank</span> <span class="o">=</span> <span class="p">((</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">rank</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
  <span class="kt">size_t</span> <span class="n">left_block_len</span> <span class="o">=</span> <span class="n">CalcBlockLen</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">,</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">nprocs</span><span class="p">,</span> <span class="n">left_rank</span><span class="p">);</span>
  <span class="kt">int</span> <span class="n">right_rank</span> <span class="o">=</span> <span class="p">((</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">rank</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">nprocs</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">rank</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
  <span class="kt">size_t</span> <span class="n">right_block_len</span> <span class="o">=</span> <span class="n">CalcBlockLen</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">,</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">nprocs</span><span class="p">,</span> <span class="n">right_rank</span><span class="p">);</span>
  <span class="kt">float</span><span class="o">*</span> <span class="n">neighbor_data</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">float</span><span class="p">[</span><span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="n">left_block_len</span><span class="p">,</span> <span class="n">right_block_len</span><span class="p">)];</span>
  <span class="kt">float</span><span class="o">*</span> <span class="n">merged_data</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">float</span><span class="p">[</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span><span class="p">];</span>
  <span class="n">MPI_Status</span> <span class="n">status</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nprocs</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">^</span> <span class="p">((</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">rank</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">right_block_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c1">// no neighbor</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="n">MPI_Sendrecv</span><span class="p">(</span><span class="cm">/*sendbuf=*/</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                   <span class="cm">/*sendcount=*/</span><span class="mi">1</span><span class="p">,</span>
                   <span class="cm">/*sendtype=*/</span><span class="n">MPI_FLOAT</span><span class="p">,</span> <span class="cm">/*dest=*/</span><span class="n">right_rank</span><span class="p">,</span>
                   <span class="cm">/*sendtag=*/</span><span class="n">i</span><span class="p">,</span> <span class="cm">/*recvbuf=*/</span><span class="n">neighbor_data</span><span class="p">,</span> <span class="cm">/*recvcount=*/</span><span class="mi">1</span><span class="p">,</span>
                   <span class="cm">/*recvtype=*/</span><span class="n">MPI_FLOAT</span><span class="p">,</span> <span class="cm">/*source=*/</span><span class="n">right_rank</span><span class="p">,</span>
                   <span class="cm">/*recvtag=*/</span><span class="n">i</span><span class="p">,</span> <span class="cm">/*comm=*/</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="cm">/*status=*/</span><span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">neighbor_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1">// no need to merge</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="n">MPI_Sendrecv</span><span class="p">(</span><span class="cm">/*sendbuf=*/</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="cm">/*sendcount=*/</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span><span class="p">,</span>
                   <span class="cm">/*sendtype=*/</span><span class="n">MPI_FLOAT</span><span class="p">,</span> <span class="cm">/*dest=*/</span><span class="n">right_rank</span><span class="p">,</span>
                   <span class="cm">/*sendtag=*/</span><span class="n">i</span><span class="p">,</span>
                   <span class="cm">/*recvbuf=*/</span><span class="n">neighbor_data</span><span class="p">,</span> <span class="cm">/*recvcount=*/</span><span class="n">right_block_len</span><span class="p">,</span>
                   <span class="cm">/*recvtype=*/</span><span class="n">MPI_FLOAT</span><span class="p">,</span> <span class="cm">/*source=*/</span><span class="n">right_rank</span><span class="p">,</span>
                   <span class="cm">/*recvtag=*/</span><span class="n">i</span><span class="p">,</span> <span class="cm">/*comm=*/</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="cm">/*status=*/</span><span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
      <span class="kt">size_t</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">while</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span> <span class="o">&amp;&amp;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">right_block_len</span> <span class="o">&amp;&amp;</span>
             <span class="n">l</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">neighbor_data</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="p">{</span>
          <span class="n">merged_data</span><span class="p">[</span><span class="n">l</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">];</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="n">merged_data</span><span class="p">[</span><span class="n">l</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">neighbor_data</span><span class="p">[</span><span class="n">k</span><span class="o">++</span><span class="p">];</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">while</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span> <span class="o">&amp;&amp;</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span><span class="p">)</span>
        <span class="n">merged_data</span><span class="p">[</span><span class="n">l</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">];</span>
      <span class="k">while</span> <span class="p">(</span><span class="n">k</span> <span class="o">&lt;</span> <span class="n">right_block_len</span> <span class="o">&amp;&amp;</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span><span class="p">)</span>
        <span class="n">merged_data</span><span class="p">[</span><span class="n">l</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">neighbor_data</span><span class="p">[</span><span class="n">k</span><span class="o">++</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">left_block_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c1">// no neighbor</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="n">MPI_Sendrecv</span><span class="p">(</span><span class="cm">/*sendbuf=*/</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
                   <span class="cm">/*sendcount=*/</span><span class="mi">1</span><span class="p">,</span>
                   <span class="cm">/*sendtype=*/</span><span class="n">MPI_FLOAT</span><span class="p">,</span> <span class="cm">/*dest=*/</span><span class="n">left_rank</span><span class="p">,</span>
                   <span class="cm">/*sendtag=*/</span><span class="n">i</span><span class="p">,</span> <span class="cm">/*recvbuf=*/</span><span class="n">neighbor_data</span><span class="p">,</span> <span class="cm">/*recvcount=*/</span><span class="mi">1</span><span class="p">,</span>
                   <span class="cm">/*recvtype=*/</span><span class="n">MPI_FLOAT</span><span class="p">,</span> <span class="cm">/*source=*/</span><span class="n">left_rank</span><span class="p">,</span>
                   <span class="cm">/*recvtag=*/</span><span class="n">i</span><span class="p">,</span> <span class="cm">/*comm=*/</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="cm">/*status=*/</span><span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">neighbor_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1">// no need to merge</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="n">MPI_Sendrecv</span><span class="p">(</span><span class="cm">/*sendbuf=*/</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="cm">/*sendcount=*/</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span><span class="p">,</span>
                   <span class="cm">/*sendtype=*/</span><span class="n">MPI_FLOAT</span><span class="p">,</span> <span class="cm">/*dest=*/</span><span class="n">left_rank</span><span class="p">,</span>
                   <span class="cm">/*sendtag=*/</span><span class="n">i</span><span class="p">,</span>
                   <span class="cm">/*recvbuf=*/</span><span class="n">neighbor_data</span><span class="p">,</span> <span class="cm">/*recvcount=*/</span><span class="n">left_block_len</span><span class="p">,</span>
                   <span class="cm">/*recvtype=*/</span><span class="n">MPI_FLOAT</span><span class="p">,</span> <span class="cm">/*source=*/</span><span class="n">left_rank</span><span class="p">,</span>
                   <span class="cm">/*recvtag=*/</span><span class="n">i</span><span class="p">,</span> <span class="cm">/*comm=*/</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="cm">/*status=*/</span><span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
      <span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">left_block_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
          <span class="n">l</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
      <span class="k">while</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">k</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">l</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">neighbor_data</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="p">{</span>
          <span class="n">merged_data</span><span class="p">[</span><span class="n">l</span><span class="o">--</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="o">--</span><span class="p">];</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="n">merged_data</span><span class="p">[</span><span class="n">l</span><span class="o">--</span><span class="p">]</span> <span class="o">=</span> <span class="n">neighbor_data</span><span class="p">[</span><span class="n">j</span><span class="o">--</span><span class="p">];</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">while</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">l</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">merged_data</span><span class="p">[</span><span class="n">l</span><span class="o">--</span><span class="p">]</span> <span class="o">=</span> <span class="n">neighbor_data</span><span class="p">[</span><span class="n">j</span><span class="o">--</span><span class="p">];</span>
      <span class="k">while</span> <span class="p">(</span><span class="n">k</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">l</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">merged_data</span><span class="p">[</span><span class="n">l</span><span class="o">--</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="o">--</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="n">std</span><span class="o">::</span><span class="n">memcpy</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">merged_data</span><span class="p">,</span> <span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
  <span class="p">}</span>
  <span class="k">delete</span><span class="p">[]</span> <span class="n">neighbor_data</span><span class="p">;</span>
  <span class="k">delete</span><span class="p">[]</span> <span class="n">merged_data</span><span class="p">;</span>
<span class="p">}</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<h3 id="performace">
<span class="mr-2">Performace</span><a href="#performace" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>
<div class="table-wrapper"><table>
<thead><tr>
<th>Number of Nodes</th>
<th>Number of Tasks</th>
<th>Number Count</th>
<th>Execution Time</th>
<th>Speedup</th>
</tr></thead>
<tbody>
<tr>
<td>1</td>
<td>1</td>
<td>100000000</td>
<td>12513.623000 ms</td>
<td>1.</td>
</tr>
<tr>
<td>1</td>
<td>2</td>
<td>100000000</td>
<td>6665.909000 ms</td>
<td>1.8772568</td>
</tr>
<tr>
<td>1</td>
<td>4</td>
<td>100000000</td>
<td>3712.588000 ms</td>
<td>3.37059297</td>
</tr>
<tr>
<td>1</td>
<td>8</td>
<td>100000000</td>
<td>2073.758000 ms</td>
<td>6.03427353</td>
</tr>
<tr>
<td>1</td>
<td>16</td>
<td>100000000</td>
<td>1295.445000 ms</td>
<td>9.65970998</td>
</tr>
<tr>
<td>2</td>
<td>32</td>
<td>100000000</td>
<td>851.194000 ms</td>
<td>14.70125847</td>
</tr>
</tbody>
</table></div>
<h2 id="v3">
<span class="mr-2">v3</span><a href="#v3" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>
<p>Loop <code class="language-plaintext highlighter-rouge">nprocs</code> times + Non-Blocking Communication + Optimized Merge + Lazy Copy</p>
<h3 id="lazy-copy">
<span class="mr-2">Lazy Copy</span><a href="#lazy-copy" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>
<p>不必每次 Merge 后都将 Merge 的结果拷贝到原 <code class="language-plaintext highlighter-rouge">data</code> 中, 而是可以使用两个数组交替作为 "旧数据" 和 "新数据", 只需交换指针即可.</p>
<h3 id="source-code-3">
<span class="mr-2">Source Code</span><a href="#source-code-3" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>
<div class="language-c++ highlighter-rouge">
<div class="code-header"> <span data-label-text="C++"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
</pre></td>
<td class="rouge-code"><pre><span class="c1">// odd_even_sort.cpp</span>
<span class="cp">#include</span> <span class="cpf">&lt;mpi.h&gt;</span><span class="cp">
</span>
<span class="cp">#include</span> <span class="cpf">&lt;algorithm&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;cassert&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;cmath&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;cstdio&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;cstdlib&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;cstring&gt;</span><span class="cp">
</span>
<span class="cp">#include</span> <span class="cpf">"worker.h"</span><span class="cp">
</span>
<span class="kt">size_t</span> <span class="nf">CalcBlockLen</span><span class="p">(</span><span class="k">const</span> <span class="kt">size_t</span> <span class="n">n</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">nprocs</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">rank</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">size_t</span> <span class="n">block_size</span> <span class="o">=</span> <span class="n">ceiling</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">nprocs</span><span class="p">);</span>
  <span class="kt">size_t</span> <span class="n">IO_offset</span> <span class="o">=</span> <span class="n">block_size</span> <span class="o">*</span> <span class="n">rank</span><span class="p">;</span>
  <span class="kt">bool</span> <span class="n">out_of_range</span> <span class="o">=</span> <span class="n">IO_offset</span> <span class="o">&gt;=</span> <span class="n">n</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">out_of_range</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">block_size</span><span class="p">,</span> <span class="n">n</span> <span class="o">-</span> <span class="n">IO_offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Worker</span><span class="o">::</span><span class="n">sort</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">sort</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">nprocs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">left_rank</span> <span class="o">=</span> <span class="p">((</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">rank</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
  <span class="kt">size_t</span> <span class="n">left_block_len</span> <span class="o">=</span> <span class="n">CalcBlockLen</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">,</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">nprocs</span><span class="p">,</span> <span class="n">left_rank</span><span class="p">);</span>
  <span class="kt">int</span> <span class="n">right_rank</span> <span class="o">=</span> <span class="p">((</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">rank</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">nprocs</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">rank</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
  <span class="kt">size_t</span> <span class="n">right_block_len</span> <span class="o">=</span> <span class="n">CalcBlockLen</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">,</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">nprocs</span><span class="p">,</span> <span class="n">right_rank</span><span class="p">);</span>
  <span class="kt">float</span><span class="o">*</span> <span class="n">neighbor_data</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">float</span><span class="p">[</span><span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="n">left_block_len</span><span class="p">,</span> <span class="n">right_block_len</span><span class="p">)];</span>
  <span class="kt">float</span><span class="o">*</span> <span class="n">data_copy</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">float</span><span class="p">[</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span><span class="p">];</span>
  <span class="n">MPI_Request</span> <span class="n">requests</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nprocs</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">^</span> <span class="p">((</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">rank</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">right_block_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c1">// no neighbor</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="n">MPI_Sendrecv</span><span class="p">(</span><span class="cm">/*sendbuf=*/</span><span class="o">&amp;</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]),</span>
                   <span class="cm">/*sendcount=*/</span><span class="mi">1</span><span class="p">,</span> <span class="cm">/*sendtype=*/</span><span class="n">MPI_FLOAT</span><span class="p">,</span> <span class="cm">/*dest=*/</span><span class="n">right_rank</span><span class="p">,</span>
                   <span class="cm">/*sendtag=*/</span><span class="n">i</span><span class="p">,</span> <span class="cm">/*recvbuf=*/</span><span class="o">&amp;</span><span class="p">(</span><span class="n">neighbor_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                   <span class="cm">/*recvcount=*/</span><span class="mi">1</span><span class="p">,</span> <span class="cm">/*recvtype=*/</span><span class="n">MPI_FLOAT</span><span class="p">,</span>
                   <span class="cm">/*source=*/</span><span class="n">right_rank</span><span class="p">,</span> <span class="cm">/*recvtag=*/</span><span class="n">i</span><span class="p">,</span>
                   <span class="cm">/*comm=*/</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="cm">/*status=*/</span><span class="n">MPI_STATUS_IGNORE</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">neighbor_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
        <span class="c1">// no need to merge</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">MPI_Isend</span><span class="p">(</span><span class="cm">/*buf=*/</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="cm">/*count=*/</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span><span class="p">,</span>
                <span class="cm">/*datatype=*/</span><span class="n">MPI_FLOAT</span><span class="p">,</span> <span class="cm">/*dest=*/</span><span class="n">right_rank</span><span class="p">,</span> <span class="cm">/*tag=*/</span><span class="n">i</span><span class="p">,</span>
                <span class="cm">/*comm=*/</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="cm">/*request=*/</span><span class="o">&amp;</span><span class="n">requests</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
      <span class="n">MPI_Irecv</span><span class="p">(</span><span class="cm">/*buf=*/</span><span class="n">neighbor_data</span><span class="p">,</span> <span class="cm">/*count=*/</span><span class="n">right_block_len</span><span class="p">,</span>
                <span class="cm">/*datatype=*/</span><span class="n">MPI_FLOAT</span><span class="p">,</span>
                <span class="cm">/*source=*/</span><span class="n">right_rank</span><span class="p">,</span> <span class="cm">/*tag=*/</span><span class="n">i</span><span class="p">,</span> <span class="cm">/*comm=*/</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span>
                <span class="cm">/*request=*/</span><span class="o">&amp;</span><span class="n">requests</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
      <span class="kt">size_t</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">MPI_Wait</span><span class="p">(</span><span class="cm">/*request=*/</span><span class="o">&amp;</span><span class="n">requests</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="cm">/*status=*/</span><span class="n">MPI_STATUS_IGNORE</span><span class="p">);</span>
      <span class="k">while</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span> <span class="o">&amp;&amp;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">right_block_len</span> <span class="o">&amp;&amp;</span>
             <span class="n">l</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">neighbor_data</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="p">{</span>
          <span class="n">data_copy</span><span class="p">[</span><span class="n">l</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">];</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="n">data_copy</span><span class="p">[</span><span class="n">l</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">neighbor_data</span><span class="p">[</span><span class="n">k</span><span class="o">++</span><span class="p">];</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">while</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span> <span class="o">&amp;&amp;</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span><span class="p">)</span>
        <span class="n">data_copy</span><span class="p">[</span><span class="n">l</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">];</span>
      <span class="k">while</span> <span class="p">(</span><span class="n">k</span> <span class="o">&lt;</span> <span class="n">right_block_len</span> <span class="o">&amp;&amp;</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span><span class="p">)</span>
        <span class="n">data_copy</span><span class="p">[</span><span class="n">l</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">neighbor_data</span><span class="p">[</span><span class="n">k</span><span class="o">++</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">left_block_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c1">// no neighbor</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="n">MPI_Sendrecv</span><span class="p">(</span><span class="cm">/*sendbuf=*/</span><span class="o">&amp;</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                   <span class="cm">/*sendcount=*/</span><span class="mi">1</span><span class="p">,</span> <span class="cm">/*sendtype=*/</span><span class="n">MPI_FLOAT</span><span class="p">,</span> <span class="cm">/*dest=*/</span><span class="n">left_rank</span><span class="p">,</span>
                   <span class="cm">/*sendtag=*/</span><span class="n">i</span><span class="p">,</span>
                   <span class="cm">/*recvbuf=*/</span><span class="o">&amp;</span><span class="p">(</span><span class="n">neighbor_data</span><span class="p">[</span><span class="n">left_block_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]),</span>
                   <span class="cm">/*recvcount=*/</span><span class="mi">1</span><span class="p">,</span> <span class="cm">/*recvtype=*/</span><span class="n">MPI_FLOAT</span><span class="p">,</span>
                   <span class="cm">/*source=*/</span><span class="n">left_rank</span><span class="p">,</span> <span class="cm">/*recvtag=*/</span><span class="n">i</span><span class="p">,</span>
                   <span class="cm">/*comm=*/</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="cm">/*status=*/</span><span class="n">MPI_STATUS_IGNORE</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">neighbor_data</span><span class="p">[</span><span class="n">left_block_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1">// no need to merge</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="n">MPI_Isend</span><span class="p">(</span><span class="cm">/*buf=*/</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="cm">/*count=*/</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span><span class="p">,</span>
                <span class="cm">/*datatype=*/</span><span class="n">MPI_FLOAT</span><span class="p">,</span> <span class="cm">/*dest=*/</span><span class="n">left_rank</span><span class="p">,</span> <span class="cm">/*tag=*/</span><span class="n">i</span><span class="p">,</span>
                <span class="cm">/*comm=*/</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="cm">/*request=*/</span><span class="o">&amp;</span><span class="n">requests</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
      <span class="n">MPI_Irecv</span><span class="p">(</span><span class="cm">/*buf=*/</span><span class="n">neighbor_data</span><span class="p">,</span> <span class="cm">/*count=*/</span><span class="n">left_block_len</span><span class="p">,</span>
                <span class="cm">/*datatype=*/</span><span class="n">MPI_FLOAT</span><span class="p">,</span>
                <span class="cm">/*source=*/</span><span class="n">left_rank</span><span class="p">,</span> <span class="cm">/*tag=*/</span><span class="n">i</span><span class="p">,</span> <span class="cm">/*comm=*/</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span>
                <span class="cm">/*request=*/</span><span class="o">&amp;</span><span class="n">requests</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
      <span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">left_block_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
          <span class="n">l</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
      <span class="n">MPI_Wait</span><span class="p">(</span><span class="cm">/*request=*/</span><span class="o">&amp;</span><span class="n">requests</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="cm">/*status=*/</span><span class="n">MPI_STATUS_IGNORE</span><span class="p">);</span>
      <span class="k">while</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">k</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">l</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">neighbor_data</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="p">{</span>
          <span class="n">data_copy</span><span class="p">[</span><span class="n">l</span><span class="o">--</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="o">--</span><span class="p">];</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="n">data_copy</span><span class="p">[</span><span class="n">l</span><span class="o">--</span><span class="p">]</span> <span class="o">=</span> <span class="n">neighbor_data</span><span class="p">[</span><span class="n">j</span><span class="o">--</span><span class="p">];</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">while</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">l</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">data_copy</span><span class="p">[</span><span class="n">l</span><span class="o">--</span><span class="p">]</span> <span class="o">=</span> <span class="n">neighbor_data</span><span class="p">[</span><span class="n">j</span><span class="o">--</span><span class="p">];</span>
      <span class="k">while</span> <span class="p">(</span><span class="n">k</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">l</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">data_copy</span><span class="p">[</span><span class="n">l</span><span class="o">--</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="o">--</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="n">MPI_Wait</span><span class="p">(</span><span class="cm">/*request=*/</span><span class="o">&amp;</span><span class="n">requests</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="cm">/*status=*/</span><span class="n">MPI_STATUS_IGNORE</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">memcpy</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">data_copy</span><span class="p">,</span> <span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
  <span class="p">}</span>
  <span class="k">delete</span><span class="p">[]</span> <span class="n">neighbor_data</span><span class="p">;</span>
  <span class="k">delete</span><span class="p">[]</span> <span class="n">data_copy</span><span class="p">;</span>
<span class="p">}</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<h3 id="performance-3">
<span class="mr-2">Performance</span><a href="#performance-3" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>
<div class="table-wrapper"><table>
<thead><tr>
<th>Number of Nodes</th>
<th>Number of Tasks</th>
<th>Number Count</th>
<th>Execution Time</th>
<th>Speedup</th>
</tr></thead>
<tbody>
<tr>
<td>1</td>
<td>1</td>
<td>100000000</td>
<td>12509.441000 ms</td>
<td>1.</td>
</tr>
<tr>
<td>1</td>
<td>2</td>
<td>100000000</td>
<td>6715.725000 ms</td>
<td>1.86270894</td>
</tr>
<tr>
<td>1</td>
<td>4</td>
<td>100000000</td>
<td>3682.796000 ms</td>
<td>3.39672385</td>
</tr>
<tr>
<td>1</td>
<td>8</td>
<td>100000000</td>
<td>2033.162000 ms</td>
<td>6.15270254</td>
</tr>
<tr>
<td>1</td>
<td>16</td>
<td>100000000</td>
<td>1212.278000 ms</td>
<td>10.31895407</td>
</tr>
<tr>
<td>2</td>
<td>32</td>
<td>100000000</td>
<td>797.821000 ms</td>
<td>15.67950831</td>
</tr>
</tbody>
</table></div>
<h2 id="v4">
<span class="mr-2">v4</span><a href="#v4" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>
<p>采用类似 Buffered Stream 方式边计算边发送, 即每计算 <code class="language-plaintext highlighter-rouge">chunk_size</code> 个 <code class="language-plaintext highlighter-rouge">float</code> 后就进行一次 <code class="language-plaintext highlighter-rouge">Isend</code>, 使得通信能够尽可能与计算重叠. 其中, <code class="language-plaintext highlighter-rouge">send_right_buffer</code> 和 <code class="language-plaintext highlighter-rouge">recv_left_buffer</code> 采取逆向存储, 以符合逆向归并的读写顺序. 为了尽可能缩短阻塞通信的时长, 仅在将要使用某一个 buffer 时才对该 buffer 进行 <code class="language-plaintext highlighter-rouge">Waitall</code> 确保上一轮通信已完成.</p>
<h3 id="bandwidth">
<span class="mr-2">Bandwidth</span><a href="#bandwidth" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>
<div class="language-bash highlighter-rouge">
<div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td>
<td class="rouge-code"><pre><span class="nv">$ </span>srun <span class="nt">-N</span> 1 <span class="nt">-n</span> 2 osu_bw
<span class="c"># OSU MPI Bandwidth Test v5.6.3</span>
<span class="c"># Size      Bandwidth (MB/s)</span>
1                       9.47
2                      18.54
4                      38.20
8                      76.28
16                    152.38
32                    286.08
64                    598.25
128                   382.26
256                   764.46
512                  1518.65
1024                 2471.40
2048                 3541.91
4096                 4986.57
8192                 6506.46
16384                5481.32
32768                7418.92
65536               10191.21
131072              12052.71
262144              12183.31
524288              11554.38
1048576             11871.98
2097152             12109.49
4194304             12458.68
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>选取 <code class="language-plaintext highlighter-rouge">131072</code> 作为 <code class="language-plaintext highlighter-rouge">chunk_size</code>.</p>
<h3 id="source-code-4">
<span class="mr-2">Source Code</span><a href="#source-code-4" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>
<div class="language-c++ highlighter-rouge">
<div class="code-header"> <span data-label-text="C++"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
</pre></td>
<td class="rouge-code"><pre><span class="c1">// odd_even_sort.cpp</span>
<span class="cp">#include</span> <span class="cpf">&lt;mpi.h&gt;</span><span class="cp">
</span>
<span class="cp">#include</span> <span class="cpf">&lt;algorithm&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;cassert&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;cmath&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;cstdio&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;cstdlib&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;cstring&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;queue&gt;</span><span class="cp">
</span>
<span class="cp">#include</span> <span class="cpf">"worker.h"</span><span class="cp">
</span>
<span class="cp">#ifdef DEBUG
</span><span class="c1">// void PrintData(const float* data, const int count) {</span>
<span class="c1">//   for (int i = 0; i &lt; count; ++i) printf("%f, ", data[i]);</span>
<span class="c1">// }</span>
<span class="cp">#endif
</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span> <span class="o">=</span> <span class="kt">float</span><span class="p">&gt;</span>
<span class="k">class</span> <span class="nc">MPIStream</span> <span class="p">{</span>
 <span class="nl">public:</span>
  <span class="n">MPIStream</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">capacity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MPI_Datatype</span> <span class="n">datatype</span> <span class="o">=</span> <span class="n">MPI_FLOAT</span><span class="p">,</span>
            <span class="n">MPI_Comm</span> <span class="n">comm</span> <span class="o">=</span> <span class="n">MPI_COMM_WORLD</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">datatype_</span><span class="p">(</span><span class="n">datatype</span><span class="p">),</span> <span class="n">comm_</span><span class="p">(</span><span class="n">comm</span><span class="p">),</span> <span class="n">target_</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="o">-&gt;</span><span class="n">chunk_count_</span> <span class="o">=</span> <span class="n">CalcChunkCount</span><span class="p">(</span><span class="n">capacity</span><span class="p">);</span>
    <span class="k">this</span><span class="o">-&gt;</span><span class="n">data_</span> <span class="o">=</span> <span class="k">new</span> <span class="n">T</span><span class="p">[</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">chunk_count_</span> <span class="o">&lt;&lt;</span> <span class="n">kLogChunkSize</span><span class="p">];</span>
    <span class="k">this</span><span class="o">-&gt;</span><span class="n">requests_</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MPI_Request</span><span class="p">[</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">chunk_count_</span><span class="p">];</span>
    <span class="n">std</span><span class="o">::</span><span class="n">fill</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">requests_</span><span class="p">,</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">requests_</span> <span class="o">+</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">chunk_count_</span><span class="p">,</span>
              <span class="n">MPI_REQUEST_NULL</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="o">~</span><span class="n">MPIStream</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">delete</span><span class="p">[]</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">data_</span><span class="p">;</span>
    <span class="k">delete</span><span class="p">[]</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">requests_</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">virtual</span> <span class="n">T</span> <span class="n">Get</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">data_</span><span class="p">[</span><span class="n">pos</span><span class="p">];</span> <span class="p">}</span>

  <span class="k">virtual</span> <span class="n">T</span> <span class="n">ReverseGet</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">Get</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">size_</span> <span class="o">-</span> <span class="n">pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">virtual</span> <span class="kt">void</span> <span class="n">Put</span><span class="p">(</span><span class="k">const</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="o">-&gt;</span><span class="n">data_</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">virtual</span> <span class="kt">void</span> <span class="n">ReversePut</span><span class="p">(</span><span class="k">const</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="o">-&gt;</span><span class="n">Put</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">size_</span> <span class="o">-</span> <span class="n">pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">T</span><span class="o">*</span> <span class="n">Data</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">data_</span><span class="p">;</span> <span class="p">}</span>

  <span class="kt">void</span> <span class="n">Connect</span><span class="p">(</span><span class="kt">int</span> <span class="n">target</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="o">-&gt;</span><span class="n">target_</span> <span class="o">=</span> <span class="n">target</span><span class="p">;</span>
    <span class="k">this</span><span class="o">-&gt;</span><span class="n">size_</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
    <span class="k">this</span><span class="o">-&gt;</span><span class="n">chunk_count_</span> <span class="o">=</span> <span class="n">CalcChunkCount</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">CancelAll</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">chunk_count_</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
      <span class="n">MPI_Cancel</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">requests_</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
  <span class="p">}</span>

  <span class="kt">int</span> <span class="n">Waitall</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">MPI_Waitall</span><span class="p">(</span>
        <span class="cm">/*count=*/</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">chunk_count_</span><span class="p">,</span>
        <span class="cm">/*array_of_requests=*/</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">requests_</span><span class="p">,</span>
        <span class="cm">/*array_of_statuses=*/</span><span class="n">MPI_STATUSES_IGNORE</span><span class="p">);</span>
  <span class="p">}</span>

<span class="cp">#ifdef DEBUG
</span> <span class="nl">public:</span>
<span class="cp">#else
</span> <span class="nl">protected:</span>
<span class="cp">#endif
</span>  <span class="k">static</span> <span class="kt">int</span> <span class="n">CalcChunkCount</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">((</span><span class="n">size</span> <span class="o">+</span> <span class="n">kChunkSizeMask</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">kLogChunkSize</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">static</span> <span class="k">constexpr</span> <span class="kt">int</span> <span class="n">kLogChunkSize</span> <span class="o">=</span> <span class="mi">17</span><span class="p">;</span>
  <span class="k">static</span> <span class="k">constexpr</span> <span class="kt">int</span> <span class="n">kChunkSize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">kLogChunkSize</span><span class="p">);</span>
  <span class="k">static</span> <span class="k">constexpr</span> <span class="kt">int</span> <span class="n">kChunkSizeMask</span> <span class="o">=</span> <span class="p">(</span><span class="n">kChunkSize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

<span class="cp">#ifdef DEBUG
</span> <span class="nl">public:</span>
<span class="cp">#else
</span> <span class="nl">protected:</span>
<span class="cp">#endif
</span>  <span class="n">T</span><span class="o">*</span> <span class="n">data_</span><span class="p">;</span>
  <span class="n">MPI_Datatype</span> <span class="n">datatype_</span><span class="p">;</span>
  <span class="n">MPI_Comm</span> <span class="n">comm_</span><span class="p">;</span>
  <span class="n">MPI_Request</span><span class="o">*</span> <span class="n">requests_</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">size_</span><span class="p">,</span> <span class="n">chunk_count_</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">target_</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span> <span class="o">=</span> <span class="kt">float</span><span class="p">&gt;</span>
<span class="k">class</span> <span class="nc">MPIInStream</span> <span class="o">:</span> <span class="k">public</span> <span class="n">MPIStream</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
 <span class="nl">public:</span>
  <span class="n">MPIInStream</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">capacity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MPI_Datatype</span> <span class="n">datatype</span> <span class="o">=</span> <span class="n">MPI_FLOAT</span><span class="p">,</span>
              <span class="n">MPI_Comm</span> <span class="n">comm</span> <span class="o">=</span> <span class="n">MPI_COMM_WORLD</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">MPIStream</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">capacity</span><span class="p">,</span> <span class="n">datatype</span><span class="p">,</span> <span class="n">comm</span><span class="p">)</span> <span class="p">{}</span>

  <span class="k">virtual</span> <span class="n">T</span> <span class="n">Get</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">pos</span><span class="p">)</span> <span class="k">override</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">target_</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">data_</span><span class="p">[</span><span class="n">pos</span><span class="p">];</span>
    <span class="kt">int</span> <span class="n">chunk_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&gt;&gt;</span> <span class="n">kLogChunkSize</span><span class="p">);</span>
    <span class="n">MPI_Wait</span><span class="p">(</span><span class="cm">/*request=*/</span><span class="o">&amp;</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">requests_</span><span class="p">[</span><span class="n">chunk_id</span><span class="p">]),</span>
             <span class="cm">/*status=*/</span><span class="n">MPI_STATUS_IGNORE</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">data_</span><span class="p">[</span><span class="n">pos</span><span class="p">];</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">Irecv</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">target_</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">chunk_count_</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef DEBUG
</span>      <span class="c1">// int rank;</span>
      <span class="c1">// MPI_Comm_rank(MPI_COMM_WORLD, &amp;rank);</span>
      <span class="c1">// printf(</span>
      <span class="c1">//     "Irecv rank = %d, buf_pos = %d, count = %d, source = %d, tag =</span>
      <span class="c1">//     %d\n", rank, i &lt;&lt; kLogChunkSize, kChunkSize, this-&gt;target_, i);</span>
<span class="cp">#endif
</span>      <span class="n">MPI_Irecv</span><span class="p">(</span><span class="cm">/*buf=*/</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">data_</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="n">kLogChunkSize</span><span class="p">),</span>
                <span class="cm">/*count=*/</span><span class="n">kChunkSize</span><span class="p">,</span>
                <span class="cm">/*datatype=*/</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">datatype_</span><span class="p">,</span>
                <span class="cm">/*source=*/</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">target_</span><span class="p">,</span>
                <span class="cm">/*tag=*/</span><span class="n">i</span><span class="p">,</span>
                <span class="cm">/*comm=*/</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">comm_</span><span class="p">,</span>
                <span class="cm">/*request=*/</span><span class="o">&amp;</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">requests_</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">ConnectSource</span><span class="p">(</span><span class="kt">int</span> <span class="n">source</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="o">-&gt;</span><span class="n">Connect</span><span class="p">(</span><span class="cm">/*target=*/</span><span class="n">source</span><span class="p">,</span> <span class="cm">/*size=*/</span><span class="n">size</span><span class="p">);</span>
  <span class="p">}</span>

<span class="cp">#ifdef DEBUG
</span> <span class="nl">public:</span>
<span class="cp">#else
</span> <span class="nl">protected:</span>
<span class="cp">#endif
</span>  <span class="k">using</span> <span class="n">MPIStream</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">kLogChunkSize</span><span class="p">;</span>
  <span class="k">using</span> <span class="n">MPIStream</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">kChunkSize</span><span class="p">;</span>
  <span class="k">using</span> <span class="n">MPIStream</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">kChunkSizeMask</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span> <span class="o">=</span> <span class="kt">float</span><span class="p">&gt;</span>
<span class="k">class</span> <span class="nc">MPIOutStream</span> <span class="o">:</span> <span class="k">public</span> <span class="n">MPIStream</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
 <span class="nl">public:</span>
  <span class="n">MPIOutStream</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">capacity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MPI_Datatype</span> <span class="n">datatype</span> <span class="o">=</span> <span class="n">MPI_FLOAT</span><span class="p">,</span>
               <span class="n">MPI_Comm</span> <span class="n">comm</span> <span class="o">=</span> <span class="n">MPI_COMM_WORLD</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">MPIStream</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">capacity</span><span class="p">,</span> <span class="n">datatype</span><span class="p">,</span> <span class="n">comm</span><span class="p">)</span> <span class="p">{}</span>

  <span class="kt">void</span> <span class="n">Load</span><span class="p">(</span><span class="k">const</span> <span class="n">T</span><span class="o">*</span> <span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">memcpy</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">data_</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">T</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">Reverse</span><span class="p">()</span> <span class="p">{</span> <span class="n">std</span><span class="o">::</span><span class="n">reverse</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">data_</span><span class="p">,</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">data_</span> <span class="o">+</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">size_</span><span class="p">);</span> <span class="p">}</span>

  <span class="kt">void</span> <span class="n">Isend</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">target_</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">chunk_count_</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef DEBUG
</span>      <span class="c1">// int rank;</span>
      <span class="c1">// MPI_Comm_rank(MPI_COMM_WORLD, &amp;rank);</span>
      <span class="c1">// printf("Isend rank = %d, buf_pos = %d, count = %d, dest = %d, tag =</span>
      <span class="c1">// %d\n",</span>
      <span class="c1">//        rank, i &lt;&lt; kLogChunkSize, kChunkSize, this-&gt;target_, i);</span>
<span class="cp">#endif
</span>      <span class="n">MPI_Isend</span><span class="p">(</span>
          <span class="cm">/*buf=*/</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">data_</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="n">kLogChunkSize</span><span class="p">),</span>
          <span class="cm">/*count=*/</span><span class="n">kChunkSize</span><span class="p">,</span>
          <span class="cm">/*datatype=*/</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">datatype_</span><span class="p">,</span>
          <span class="cm">/*dest=*/</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">target_</span><span class="p">,</span>
          <span class="cm">/*tag=*/</span><span class="n">i</span><span class="p">,</span>
          <span class="cm">/*comm=*/</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">comm_</span><span class="p">,</span>
          <span class="cm">/*request=*/</span><span class="o">&amp;</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">requests_</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">virtual</span> <span class="kt">void</span> <span class="n">Put</span><span class="p">(</span><span class="k">const</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">override</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">target_</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">MPIStream</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">Put</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>
    <span class="k">this</span><span class="o">-&gt;</span><span class="n">data_</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">((((</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">kChunkSizeMask</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">pos</span> <span class="o">==</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">size_</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
      <span class="kt">int</span> <span class="n">chunk_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&gt;&gt;</span> <span class="n">kLogChunkSize</span><span class="p">);</span>
<span class="cp">#ifdef DEBUG
</span>      <span class="c1">// int rank;</span>
      <span class="c1">// MPI_Comm_rank(MPI_COMM_WORLD, &amp;rank);</span>
      <span class="c1">// printf("Isend rank = %d, buf_pos = %d, count = %d, dest = %d, tag =</span>
      <span class="c1">// %d\n",</span>
      <span class="c1">//        rank, chunk_id &lt;&lt; kLogChunkSize, kChunkSize, this-&gt;target_,</span>
      <span class="c1">//        chunk_id);</span>
<span class="cp">#endif
</span>      <span class="n">MPI_Isend</span><span class="p">(</span>
          <span class="cm">/*buf=*/</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">data_</span> <span class="o">+</span> <span class="p">(</span><span class="n">chunk_id</span> <span class="o">&lt;&lt;</span> <span class="n">kLogChunkSize</span><span class="p">),</span>
          <span class="cm">/*count=*/</span><span class="n">kChunkSize</span><span class="p">,</span>
          <span class="cm">/*datatype=*/</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">datatype_</span><span class="p">,</span>
          <span class="cm">/*dest=*/</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">target_</span><span class="p">,</span>
          <span class="cm">/*tag=*/</span><span class="n">chunk_id</span><span class="p">,</span>
          <span class="cm">/*comm=*/</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">comm_</span><span class="p">,</span>
          <span class="cm">/*request=*/</span><span class="o">&amp;</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">requests_</span><span class="p">[</span><span class="n">chunk_id</span><span class="p">]));</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">ConnectDest</span><span class="p">(</span><span class="kt">int</span> <span class="n">dest</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="o">-&gt;</span><span class="n">Connect</span><span class="p">(</span><span class="cm">/*target=*/</span><span class="n">dest</span><span class="p">,</span> <span class="cm">/*size=*/</span><span class="n">size</span><span class="p">);</span>
  <span class="p">}</span>

<span class="cp">#ifdef DEBUG
</span> <span class="nl">public:</span>
<span class="cp">#else
</span> <span class="nl">protected:</span>
<span class="cp">#endif
</span>  <span class="k">using</span> <span class="n">MPIStream</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">kLogChunkSize</span><span class="p">;</span>
  <span class="k">using</span> <span class="n">MPIStream</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">kChunkSize</span><span class="p">;</span>
  <span class="k">using</span> <span class="n">MPIStream</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">kChunkSizeMask</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">size_t</span> <span class="nf">CalcBlockLen</span><span class="p">(</span><span class="k">const</span> <span class="kt">size_t</span> <span class="n">n</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">nprocs</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">rank</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">size_t</span> <span class="n">block_size</span> <span class="o">=</span> <span class="n">ceiling</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">nprocs</span><span class="p">);</span>
  <span class="kt">size_t</span> <span class="n">IO_offset</span> <span class="o">=</span> <span class="n">block_size</span> <span class="o">*</span> <span class="n">rank</span><span class="p">;</span>
  <span class="kt">bool</span> <span class="n">out_of_range</span> <span class="o">=</span> <span class="n">IO_offset</span> <span class="o">&gt;=</span> <span class="n">n</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">out_of_range</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">block_size</span><span class="p">,</span> <span class="n">n</span> <span class="o">-</span> <span class="n">IO_offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Worker</span><span class="o">::</span><span class="n">sort</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">sort</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">nprocs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
<span class="cp">#ifdef DEBUG
</span>    <span class="c1">// printf("[%d] begin: ", this-&gt;rank);</span>
    <span class="c1">// for (size_t i = 0; i &lt; this-&gt;block_len; ++i) printf("%f, ",</span>
    <span class="c1">// this-&gt;data[i]); printf("\n");</span>
<span class="cp">#endif
</span>  <span class="kt">int</span> <span class="n">left_rank</span> <span class="o">=</span> <span class="p">((</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">rank</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
  <span class="kt">int</span> <span class="n">right_rank</span> <span class="o">=</span> <span class="p">((</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">rank</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">nprocs</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">rank</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
  <span class="kt">size_t</span> <span class="n">left_block_len</span> <span class="o">=</span> <span class="n">CalcBlockLen</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">,</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">nprocs</span><span class="p">,</span> <span class="n">left_rank</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">left_block_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">left_rank</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="kt">size_t</span> <span class="n">right_block_len</span> <span class="o">=</span> <span class="n">CalcBlockLen</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">,</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">nprocs</span><span class="p">,</span> <span class="n">right_rank</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">right_block_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">right_rank</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="k">auto</span> <span class="n">send_left_buffer</span> <span class="o">=</span> <span class="n">MPIOutStream</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="cm">/*capacity=*/</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span><span class="p">);</span>
  <span class="n">send_left_buffer</span><span class="p">.</span><span class="n">ConnectDest</span><span class="p">(</span><span class="cm">/*dest=*/</span><span class="n">left_rank</span><span class="p">,</span> <span class="cm">/*size=*/</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span><span class="p">);</span>
  <span class="n">send_left_buffer</span><span class="p">.</span><span class="n">Load</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span><span class="p">);</span>
  <span class="k">auto</span> <span class="n">send_right_buffer</span> <span class="o">=</span> <span class="n">MPIOutStream</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="cm">/*capacity=*/</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span><span class="p">);</span>
  <span class="n">send_right_buffer</span><span class="p">.</span><span class="n">ConnectDest</span><span class="p">(</span><span class="cm">/*dest=*/</span><span class="n">right_rank</span><span class="p">,</span> <span class="cm">/*size=*/</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span><span class="p">);</span>
  <span class="n">send_right_buffer</span><span class="p">.</span><span class="n">Load</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span><span class="p">);</span>
  <span class="n">send_right_buffer</span><span class="p">.</span><span class="n">Reverse</span><span class="p">();</span>
  <span class="k">auto</span> <span class="n">recv_left_buffer</span> <span class="o">=</span> <span class="n">MPIInStream</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="cm">/*capacity=*/</span><span class="n">left_block_len</span><span class="p">);</span>
  <span class="n">recv_left_buffer</span><span class="p">.</span><span class="n">ConnectSource</span><span class="p">(</span><span class="cm">/*source=*/</span><span class="n">left_rank</span><span class="p">,</span> <span class="cm">/*size=*/</span><span class="n">left_block_len</span><span class="p">);</span>
  <span class="k">auto</span> <span class="n">recv_right_buffer</span> <span class="o">=</span> <span class="n">MPIInStream</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="cm">/*capacity=*/</span><span class="n">right_block_len</span><span class="p">);</span>
  <span class="n">recv_right_buffer</span><span class="p">.</span><span class="n">ConnectSource</span><span class="p">(</span><span class="cm">/*source=*/</span><span class="n">right_rank</span><span class="p">,</span>
                                  <span class="cm">/*size=*/</span><span class="n">right_block_len</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">rank</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">send_right_buffer</span><span class="p">.</span><span class="n">Isend</span><span class="p">();</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">send_left_buffer</span><span class="p">.</span><span class="n">Isend</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">nprocs</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// printf("!!! Rank = %d, i = %d\n", this-&gt;rank, i);</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">^</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">rank</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// recv from right, send to left</span>
      <span class="n">send_left_buffer</span><span class="p">.</span><span class="n">Waitall</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">nprocs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="n">send_left_buffer</span><span class="p">.</span><span class="n">ConnectDest</span><span class="p">(</span><span class="cm">/*dest=*/</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">right_block_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">send_left_buffer</span><span class="p">.</span><span class="n">Load</span><span class="p">(</span><span class="n">send_right_buffer</span><span class="p">.</span><span class="n">Data</span><span class="p">(),</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span><span class="p">);</span>
        <span class="n">send_left_buffer</span><span class="p">.</span><span class="n">Reverse</span><span class="p">();</span>
        <span class="n">send_left_buffer</span><span class="p">.</span><span class="n">Isend</span><span class="p">();</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">recv_right_buffer</span><span class="p">.</span><span class="n">Waitall</span><span class="p">();</span>
        <span class="n">recv_right_buffer</span><span class="p">.</span><span class="n">Irecv</span><span class="p">();</span>
        <span class="kt">size_t</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span> <span class="o">&amp;&amp;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">right_block_len</span> <span class="o">&amp;&amp;</span>
               <span class="n">l</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">send_right_buffer</span><span class="p">.</span><span class="n">ReverseGet</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">recv_right_buffer</span><span class="p">.</span><span class="n">Get</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">send_left_buffer</span><span class="p">.</span><span class="n">Put</span><span class="p">(</span><span class="n">send_right_buffer</span><span class="p">.</span><span class="n">ReverseGet</span><span class="p">(</span><span class="n">j</span><span class="o">++</span><span class="p">),</span> <span class="n">l</span><span class="o">++</span><span class="p">);</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">send_left_buffer</span><span class="p">.</span><span class="n">Put</span><span class="p">(</span><span class="n">recv_right_buffer</span><span class="p">.</span><span class="n">Get</span><span class="p">(</span><span class="n">k</span><span class="o">++</span><span class="p">),</span> <span class="n">l</span><span class="o">++</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span> <span class="o">&amp;&amp;</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span><span class="p">)</span>
          <span class="n">send_left_buffer</span><span class="p">.</span><span class="n">Put</span><span class="p">(</span><span class="n">send_right_buffer</span><span class="p">.</span><span class="n">ReverseGet</span><span class="p">(</span><span class="n">j</span><span class="o">++</span><span class="p">),</span> <span class="n">l</span><span class="o">++</span><span class="p">);</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">k</span> <span class="o">&lt;</span> <span class="n">right_block_len</span> <span class="o">&amp;&amp;</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span><span class="p">)</span>
          <span class="n">send_left_buffer</span><span class="p">.</span><span class="n">Put</span><span class="p">(</span><span class="n">recv_right_buffer</span><span class="p">.</span><span class="n">Get</span><span class="p">(</span><span class="n">k</span><span class="o">++</span><span class="p">),</span> <span class="n">l</span><span class="o">++</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// recv from left, send to right</span>
      <span class="n">send_right_buffer</span><span class="p">.</span><span class="n">Waitall</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">nprocs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="n">send_right_buffer</span><span class="p">.</span><span class="n">ConnectDest</span><span class="p">(</span><span class="cm">/*dest=*/</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">left_block_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">send_right_buffer</span><span class="p">.</span><span class="n">Load</span><span class="p">(</span><span class="n">send_left_buffer</span><span class="p">.</span><span class="n">Data</span><span class="p">(),</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span><span class="p">);</span>
        <span class="n">send_right_buffer</span><span class="p">.</span><span class="n">Reverse</span><span class="p">();</span>
        <span class="n">send_right_buffer</span><span class="p">.</span><span class="n">Isend</span><span class="p">();</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">recv_left_buffer</span><span class="p">.</span><span class="n">Waitall</span><span class="p">();</span>
        <span class="n">recv_left_buffer</span><span class="p">.</span><span class="n">Irecv</span><span class="p">();</span>
        <span class="kt">size_t</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span> <span class="o">&amp;&amp;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">left_block_len</span> <span class="o">&amp;&amp;</span>
               <span class="n">l</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">send_left_buffer</span><span class="p">.</span><span class="n">ReverseGet</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">recv_left_buffer</span><span class="p">.</span><span class="n">Get</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">send_right_buffer</span><span class="p">.</span><span class="n">Put</span><span class="p">(</span><span class="n">send_left_buffer</span><span class="p">.</span><span class="n">ReverseGet</span><span class="p">(</span><span class="n">j</span><span class="o">++</span><span class="p">),</span> <span class="n">l</span><span class="o">++</span><span class="p">);</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">send_right_buffer</span><span class="p">.</span><span class="n">Put</span><span class="p">(</span><span class="n">recv_left_buffer</span><span class="p">.</span><span class="n">Get</span><span class="p">(</span><span class="n">k</span><span class="o">++</span><span class="p">),</span> <span class="n">l</span><span class="o">++</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span> <span class="o">&amp;&amp;</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span><span class="p">)</span>
          <span class="n">send_right_buffer</span><span class="p">.</span><span class="n">Put</span><span class="p">(</span><span class="n">send_left_buffer</span><span class="p">.</span><span class="n">ReverseGet</span><span class="p">(</span><span class="n">j</span><span class="o">++</span><span class="p">),</span> <span class="n">l</span><span class="o">++</span><span class="p">);</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">k</span> <span class="o">&lt;</span> <span class="n">left_block_len</span> <span class="o">&amp;&amp;</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span><span class="p">)</span>
          <span class="n">send_right_buffer</span><span class="p">.</span><span class="n">Put</span><span class="p">(</span><span class="n">recv_left_buffer</span><span class="p">.</span><span class="n">Get</span><span class="p">(</span><span class="n">k</span><span class="o">++</span><span class="p">),</span> <span class="n">l</span><span class="o">++</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">((</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">rank</span> <span class="o">^</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">nprocs</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">memcpy</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">send_right_buffer</span><span class="p">.</span><span class="n">Data</span><span class="p">(),</span>
                <span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
    <span class="n">std</span><span class="o">::</span><span class="n">reverse</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">memcpy</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">send_left_buffer</span><span class="p">.</span><span class="n">Data</span><span class="p">(),</span>
                <span class="k">this</span><span class="o">-&gt;</span><span class="n">block_len</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
  <span class="p">}</span>
  <span class="n">send_left_buffer</span><span class="p">.</span><span class="n">Waitall</span><span class="p">();</span>
  <span class="n">send_right_buffer</span><span class="p">.</span><span class="n">Waitall</span><span class="p">();</span>
  <span class="n">recv_left_buffer</span><span class="p">.</span><span class="n">Waitall</span><span class="p">();</span>
  <span class="n">recv_right_buffer</span><span class="p">.</span><span class="n">Waitall</span><span class="p">();</span>
<span class="cp">#ifdef DEBUG
</span>  <span class="c1">// printf("[%d] end send_left: ", this-&gt;rank);</span>
  <span class="c1">// PrintData(send_left_buffer.Data(), this-&gt;block_len);</span>
  <span class="c1">// printf("\n");</span>
  <span class="c1">// printf("[%d] end send_right: ", this-&gt;rank);</span>
  <span class="c1">// PrintData(send_right_buffer.Data(), this-&gt;block_len);</span>
  <span class="c1">// printf("\n");</span>
  <span class="c1">// printf("[%d] end recv_left: ", this-&gt;rank);</span>
  <span class="c1">// PrintData(recv_left_buffer.Data(), left_block_len);</span>
  <span class="c1">// printf("\n");</span>
  <span class="c1">// printf("[%d] end recv_right: ", this-&gt;rank);</span>
  <span class="c1">// PrintData(recv_right_buffer.Data(), right_block_len);</span>
  <span class="c1">// printf("\n");</span>
<span class="cp">#endif
</span><span class="p">}</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<h3 id="performance-4">
<span class="mr-2">Performance</span><a href="#performance-4" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h3>
<p>由于逻辑变得复杂, 效果非常不理想.</p>
<div class="table-wrapper"><table>
<thead><tr>
<th>Number of Nodes</th>
<th>Number of Tasks</th>
<th>Number Count</th>
<th>Execution Time</th>
<th>Speedup</th>
</tr></thead>
<tbody>
<tr>
<td>1</td>
<td>1</td>
<td>100000000</td>
<td>12483.309000 ms</td>
<td>1.</td>
</tr>
<tr>
<td>1</td>
<td>2</td>
<td>100000000</td>
<td>7433.843000 ms</td>
<td>1.67925379</td>
</tr>
<tr>
<td>1</td>
<td>4</td>
<td>100000000</td>
<td>5337.546000 ms</td>
<td>2.3387731</td>
</tr>
<tr>
<td>1</td>
<td>8</td>
<td>100000000</td>
<td>3785.481000 ms</td>
<td>3.29768106</td>
</tr>
<tr>
<td>1</td>
<td>16</td>
<td>100000000</td>
<td>2839.709000 ms</td>
<td>4.39598177</td>
</tr>
<tr>
<td>2</td>
<td>32</td>
<td>100000000</td>
<td>2490.944000 ms</td>
<td>5.01147717</td>
</tr>
</tbody>
</table></div>
<div class="footnotes" role="doc-endnotes"><ol>
<li id="fn:6" role="doc-endnote"><p><a href="http://liinwww.ira.uka.de/~thw/vl-hiroshima/slides-4.pdf">"Five Lectures on CA"</a> (PDF). <em>Liinwww.ira.uka.de</em>. Retrieved 2017-07-30. <a href="#fnref:6" class="reversefootnote" role="doc-backlink">↩</a></p></li>
<li id="fn:7" role="doc-endnote"><p>Lang, Hans Werner. <a href="http://www.iti.fh-flensburg.de/lang/algorithmen/sortieren/networks/nulleinsen.htm">"The 0-1-principle"</a>. <em>Iti.fh-flensburg.de</em>. Retrieved 30 July 2017. <a href="#fnref:7" class="reversefootnote" role="doc-backlink">↩</a></p></li>
<li id="fn:8" role="doc-endnote"><p><a href="http://www.net.t-labs.tu-berlin.de/~stefan/netalg13-9-sort.pdf">"Distributed Sorting"</a> (PDF). <em>Net.t-labs.tu-berlin.de</em>. Retrieved 2017-07-30. <a href="#fnref:8" class="reversefootnote" role="doc-backlink">↩</a></p></li>
</ol></div>
</div>
<div class="post-tail-wrapper text-muted">
<div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href="/categories/course-work/">Course Work</a>, <a href="/categories/introduction-to-high-performance-computing/">Introduction to High Performance Computing</a>
</div>
<div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/hpc/" class="post-tag no-text-decoration">HPC</a> <a href="/tags/mpi/" class="post-tag no-text-decoration">MPI</a>
</div>
<div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2">
<div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div>
<div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=PA1%3A+%E5%A5%87%E5%81%B6%E6%8E%92%E5%BA%8F%EF%BC%88odd_even_sort%EF%BC%89+-+liblaf%27s+Blog&amp;url=https%3A%2F%2Fblog.liblaf.top%2Fcourse-work%2Fintroduction-to-high-performance-computing%2F2022%2F04%2F10%2Fpa1-odd_even_sort%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=PA1%3A+%E5%A5%87%E5%81%B6%E6%8E%92%E5%BA%8F%EF%BC%88odd_even_sort%EF%BC%89+-+liblaf%27s+Blog&amp;u=https%3A%2F%2Fblog.liblaf.top%2Fcourse-work%2Fintroduction-to-high-performance-computing%2F2022%2F04%2F10%2Fpa1-odd_even_sort%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fblog.liblaf.top%2Fcourse-work%2Fintroduction-to-high-performance-computing%2F2022%2F04%2F10%2Fpa1-odd_even_sort%2F&text=PA1%3A+%E5%A5%87%E5%81%B6%E6%8E%92%E5%BA%8F%EF%BC%88odd_even_sort%EF%BC%89+-+liblaf%27s+Blog" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fblog.liblaf.top%2Fcourse-work%2Fintroduction-to-high-performance-computing%2F2022%2F04%2F10%2Fpa1-odd_even_sort%2F" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <a href="http://service.weibo.com/share/share.php?title=PA1%3A+%E5%A5%87%E5%81%B6%E6%8E%92%E5%BA%8F%EF%BC%88odd_even_sort%EF%BC%89+-+liblaf%27s+Blog&amp;url=https%3A%2F%2Fblog.liblaf.top%2Fcourse-work%2Fintroduction-to-high-performance-computing%2F2022%2F04%2F10%2Fpa1-odd_even_sort%2F" data-toggle="tooltip" data-placement="top" title="Weibo" target="_blank" rel="noopener" aria-label="Weibo"> <i class="fa-fw fab fa-weibo"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span>
</div>
</div>
</div>
</div></div>
<div id="panel-wrapper" class="col-xl-3 pl-2 text-muted">
<div class="access">
<div id="access-lastmod" class="post">
<div class="panel-heading">Recently Updated</div>
<ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/linux/2022/01/26/how-to-build-linux-kernel/">How to Build Linux Kernel</a></li></ul>
</div>
<div id="access-tags">
<div class="panel-heading">Trending Tags</div>
<div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/hpc/">HPC</a> <a class="post-tag" href="/tags/bomb-lab/">Bomb Lab</a> <a class="post-tag" href="/tags/oslab/">OSLAB</a> <a class="post-tag" href="/tags/untagged/">untagged</a> <a class="post-tag" href="/tags/linux-kernel/">Linux Kernel</a> <a class="post-tag" href="/tags/linux-device-drivers/">Linux Device Drivers</a> <a class="post-tag" href="/tags/attack-lab/">Attack Lab</a> <a class="post-tag" href="/tags/cuda/">CUDA</a> <a class="post-tag" href="/tags/mpi/">MPI</a> <a class="post-tag" href="/tags/char-drivers/">Char Drivers</a>
</div>
</div>
</div>
<script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5">
<div class="panel-heading pl-3 pt-2 mb-2">Contents</div>
<nav id="toc" data-toggle="toc"></nav>
</div>
</div>
</div>
<div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4">
<div id="related-posts" class="mt-5 mb-2 mb-sm-4">
<h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3>
<div class="card-deck mb-4">
<div class="card"> <a href="/course-work/introduction-to-high-performance-computing/2022/03/15/exp1-mpi-%E5%BC%82%E6%AD%A5%E9%80%9A%E4%BF%A1/"><div class="card-body"> <em class="small" data-ts="1647273600" data-df="ll"> Mar 15, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>exp1: MPI 异步通信</h3>
<div class="text-muted small"><p> 任务一 编号 消息长度 计算量 总耗时 1 16384 0 0.203542 ms 2 32768 0 0.431834 ms 3 6...</p></div>
</div></a>
</div>
<div class="card"> <a href="/course-work/introduction-to-high-performance-computing/2022/03/21/exp2-mpi-allreduce/"><div class="card-body"> <em class="small" data-ts="1647792000" data-df="ll"> Mar 21, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>exp2: MPI Allreduce</h3>
<div class="text-muted small"><p> Ring Allreduce 算法 首先将每个结点的数据分为 comm_sz 个数据块, 每个数据块大小为 count = n / comm_sz 个 float. 第一阶段共 comm_sz - 1 步. 在第 k 步, 第 my_rank 个进程会将自己的第 (my_rank - k) % comm_sz 对应数据块发送给第 succ = my_rank + 1 个进程并累加. 注意...</p></div>
</div></a>
</div>
<div class="card"> <a href="/course-work/introduction-to-high-performance-computing/2022/05/17/pa2-%E6%A8%A1%E6%9D%BF%E8%AE%A1%E7%AE%97/"><div class="card-body"> <em class="small" data-ts="1652716800" data-df="ll"> May 17, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>PA2: 模板计算</h3>
<div class="text-muted small"><p> Size: 512 x 512 x 512 Naive No OPT Performance Threads Computation Time (s) Performance (Gflop/s) Speedup / Single Thread 1 267.07548...</p></div>
</div></a>
</div>
</div>
</div>
<div class="post-navigation d-flex justify-content-between"> <a href="/course-work/introduction-to-high-performance-computing/2022/04/04/exp4-%E8%87%AA%E5%8A%A8%E5%90%91%E9%87%8F%E5%8C%96%E4%B8%8E%E5%9F%BA%E4%BA%8E-intrinsic-%E7%9A%84%E6%89%8B%E5%8A%A8%E5%90%91%E9%87%8F%E5%8C%96/" class="btn btn-outline-primary" prompt="Older"><p>exp4: 自动向量化与基于 intrinsic 的手动向量化</p></a> <a href="/latex/2022/04/10/how-to-use-more-than-10-columns-in-matrix/" class="btn btn-outline-primary" prompt="Newer"><p>How To Use More Than 10 Columns in Matrix</p></a>
</div>
<script type="text/javascript"> $(function () { const origin = "https://giscus.app"; const iframe = "iframe.giscus-frame"; const lightTheme = "light"; const darkTheme = "dark_dimmed"; let initTheme = lightTheme; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches)) { initTheme = darkTheme; } let giscusAttributes = { "src": "https://giscus.app/client.js", "data-repo": "liblaf/blog", "data-repo-id": "R_kgDOHkfdiA", "data-category": "General", "data-category-id": "DIC_kwDOHkfdiM4CP6eD", "data-mapping": "pathname", "data-reactions-enabled": "1", "data-emit-metadata": "0", "data-theme": initTheme, "data-input-position": "top", "data-lang": "en", "crossorigin": "anonymous", "async": "" }; let giscusScript = document.createElement("script"); Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value)); document.getElementById("tail-wrapper").appendChild(giscusScript); addEventListener("message", (event) => { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { /* global theme mode changed */ const mode = event.data.message; const theme = (mode === ModeToggle.DARK_MODE ? darkTheme : lightTheme); const message = { setConfig: { theme: theme } }; const giscus = document.querySelector(iframe).contentWindow; giscus.postMessage({ giscus: message }, origin); } }); }); </script>
</div></div>
<footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0">
<div class="footer-left"> <span id="busuanzi_container_site_pv"> <b class="pageviews"> <span id="busuanzi_value_site_pv"> <i class="fas fa-spinner fa-spin fa-fw"></i> </span> </b> site views </span><p class="mb-0"> © 2022 <a href="https://github.com/liblaf">Qin Li</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p>
</div>
<div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div>
</div></footer>
</div>
<div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content">
<div id="search-hints"><div id="access-tags">
<div class="panel-heading">Trending Tags</div>
<div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/hpc/">HPC</a> <a class="post-tag" href="/tags/bomb-lab/">Bomb Lab</a> <a class="post-tag" href="/tags/oslab/">OSLAB</a> <a class="post-tag" href="/tags/untagged/">untagged</a> <a class="post-tag" href="/tags/linux-kernel/">Linux Kernel</a> <a class="post-tag" href="/tags/linux-device-drivers/">Linux Device Drivers</a> <a class="post-tag" href="/tags/attack-lab/">Attack Lab</a> <a class="post-tag" href="/tags/cuda/">CUDA</a> <a class="post-tag" href="/tags/mpi/">MPI</a> <a class="post-tag" href="/tags/char-drivers/">Char Drivers</a>
</div>
</div></div>
<div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
</div></div>
</div>
<script src="https://cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js"></script> <script> $(function() { function updateMermaid(event) { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { const mode = event.data.message; if (typeof mermaid === "undefined") { return; } let expectedTheme = (mode === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* Re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } let initTheme = "default"; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches ) ) { initTheme = "dark"; } let mermaidConf = { theme: initTheme /* <default|dark|forest|neutral> */ }; /* Markdown converts to HTML */ $("pre").has("code.language-mermaid").each(function() { let svgCode = $(this).children().html(); $(this).addClass("unloaded"); $(this).after(`<div class=\"mermaid\">${svgCode}</div>`); }); mermaid.initialize(mermaidConf); window.addEventListener("message", updateMermaid); }); </script><div id="mask"></div>
<a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false">
<div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">×</span> </button>
</div>
<div class="toast-body text-center pt-0">
<p class="pl-2 pr-2 mb-3">A new version of content is available.</p>
<button type="button" class="btn btn-primary" aria-label="Update"> Update </button>
</div>
</div>
<script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script src="/assets/js/math.js" defer></script> <script id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-svg-full.js" defer></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"> </script>
</body>
</html>
